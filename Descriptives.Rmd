---
title: "Descriptives"
author: "Paul Stricker"
date: "2023-11-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(dplyr)
library(tidyr)
library(patchwork)
library(ggplot2)
library(readxl)
library(knitr)

load("port_data.RData")

port_data <- filter(port_data, aggregate==0, stat_port==1) 
                    #,average_yrly >=100)   # filter out aggregates and small ports
```

# What is the relevant sample? 

## Which type of cargo?

Most throughput of energy commodities (transported in bulks) and Ro-Ro comes from countries other than China. The highest share of Chinese products is shipped with container cargo. Therefore, the sample is restricted to container cargo only.

```{r , echo=FALSE,message=FALSE}
theme_set(theme_minimal() + theme(legend.position = 'none'))

port_data %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)"))) %>%
  pivot_longer(cols = c("roro", "bulk", "container", "other"), names_to = "type", values_to = "throughput") %>%
  group_by(type, china) %>% summarize(throughput = sum(throughput, na.rm = T)) %>% 
  ggplot(aes(y=throughput, x=reorder(type, desc(throughput)))) + geom_bar(stat="identity", position = "stack", aes(fill = china) ) +
  xlab("cargo type") + 
  labs(title="Throughput by type", caption = "Blue bars represent cargo from China.")


```

## Which ports are relevant? 

```{r include=FALSE}
through_put_by_ports <- port_data %>% filter(year>=2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") &                                          container>0)) %>%
                        group_by(port) %>% summarise(throughput=sum(container, na.rm=T), china=max(china), 
                                                     nat_stat_group = max(nat_stat_group),  
                                                     average_yrly=max(average_yrly)) %>% ungroup() %>%
                        mutate(throughput = throughput/sum(throughput)) %>% arrange(desc(throughput)) %>% 
                        mutate(cumsum=cumsum(throughput))
                        
```

Most of the throughput concentrates in a few hundred ports. Limiting the sample to `r sum(through_put_by_ports$cumsum<.99)` ports that are responsible for 99 percent of the container shipments might be a sensible option (`r sum(through_put_by_ports$nat_stat_group[through_put_by_ports$cumsum<.99])` of these are aggregates of ports). Additionally, not all ports process Chinese goods. While all major ports do, especially small ports usually do not. 

```{r echo=FALSE}

port_data %>% filter(year>=2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & container>0)) %>%
         group_by(port) %>% summarise(throughput=sum(container, na.rm=T), china=max(china, na.rm = T)) %>% ungroup() %>%
         mutate(throughput = throughput/sum(throughput)) %>% arrange(desc(throughput)) %>% mutate(n=row_number()) %>%
         ggplot( aes(x=n, y=cumsum(throughput))) + geom_point(aes(colour = china)) + 
         ylab("cummulative share of throughput") +
         xlab("number of ports") +
         labs(title = "Cumulative container throughput by ports (2010-2023)", caption = "Blue dots are ports that process chinese goods.") 
# 223 ports make up for 95 percent of shipments



```

```{r, include=F}
cut_offs <- port_data %>% filter(year>=2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") &                                          container>0)) %>%
                        group_by(port) %>% summarise(throughput=sum(container, na.rm=T), china=max(china), 
                                                     nat_stat_group = max(nat_stat_group),  
                                                     average_yrly = max(average_yrly)) %>% ungroup() %>%
                        mutate(throughput = throughput/sum(throughput)) %>% arrange(average_yrly) %>% 
                        mutate(cumsum=cumsum(throughput))

```


An alternative to filtering by the aggregated throughput could be filtering by the average throughput. The two graphs below display the cumulative total throughput relative to the average yearly throughput. The second graph indicates that possible cut-off thresholds of 50, 75, and 100 thousand to tonnes of yearly average container throughput are associated with a loss of `r round(max(cut_offs$cumsum[cut_offs$average_yrly<=50])*100, digits = 1 )`, `r round(max(cut_offs$cumsum[cut_offs$average_yrly<=75])*100, digits = 1 )`, and `r round(max(cut_offs$cumsum[cut_offs$average_yrly<=100])*100, digits = 1 )` percent of the cumulative total container throughput. In the following, the sample is constructed by applying a threshold of 100 thousand tonnes of average yearly container throughput.  

```{r echo=FALSE,message=FALSE}


port_data %>% filter(year>=2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & container>0)) %>%
         group_by(port) %>% summarise(throughput=sum(container, na.rm=T), 
                                      china=max(china, na.rm = T),
                                      average_yrly = mean(average_yrly, na.rm=T)) %>% ungroup() %>%
         mutate(throughput = throughput/sum(throughput)) %>% arrange(average_yrly) %>% 
         ggplot( aes(x=average_yrly, y=cumsum(throughput))) + geom_point(aes(colour = china)) + 
         geom_vline(xintercept = 50) +
         geom_vline(xintercept = 75) +
         geom_vline(xintercept = 100) +
         coord_cartesian(ylim=c(0,0.02), xlim=c(0,100)) +
         ylab("cummulative share of throughput") +
         xlab("average yearly container throughput") +
         labs(title = "Possible cut-offs", caption = "Blue dots are ports that process chinese goods.")


```


```{r, include=FALSE}
port_data <- filter(port_data, average_yrly >=100) #exclude port that have an average yearly container throughput above 100
```

# Sample

## Descriptives

```{r include=FALSE}

# share of national statistical groups
share <- port_data %>% mutate(stat_port = stat_port*container,
                              nat_stat_group = nat_stat_group*container) %>%
                       summarize(stat_port = sum(stat_port, na.rm=T),
                                 nat_stat_group = sum(nat_stat_group, na.rm = T)) %>%
                       mutate(share = round(nat_stat_group/(stat_port)*100, digits = 1)) %>%
                       pull(share)

#number of reporting countries
n_reporter <- as.numeric(length(unique(port_data$reporter[!is.na(port_data$container)])))


# number of ports
n_ports <- as.numeric(length(unique(port_data$port[!is.na(port_data$container)])))

# number of sending countries
n_sender <- as.numeric(length(unique(port_data$sender[!is.na(port_data$container)])))

# number of periods
n_quarters <- as.numeric(length(unique(port_data$time[!is.na(port_data$container)])))

# number of ports with zero throughput
n_ports_nz <- port_data %>% group_by(port) %>% 
              summarise(throughput = sum(container)) %>% 
              filter(throughput==0) %>% nrow() %>%
              as.numeric()

```


The statistical units in the Eurostat data are a mixed list of actual ports and grouped ports (statistical ports) and geographic areas, which represent aggregates of many ports. While the port groups "usually" have one port management, this cannot be assumed for everyone. In addition, statistical ports that represent a group of ports make up the majority of the container shipments (`r share` percent). The definition of the statistical units (statistical ports and geographic aggregates) can be found in the [metadata](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=uriserv:OJ.L_.2018.180.01.0029.01.ENG&toc=OJ:L:2018:180:FULL), and in the [annex](https://ec.europa.eu/eurostat/cache/metadata/Annexes/mar_esms_an_2.xlsx). As of now, the sample is restricted to statistical ports (no geographic aggregates). The remaining sample includes:

- `r n_reporter` reporting countries
- `r n_ports` ports (only `r n_ports_nz` with zero throughput)
- `r n_sender` origin countries
- `r n_quarters` time periods (quarters)

```{r include=F}
nat_stat_groups <- read_xlsx("mar_esms_an_2.xlsx", sheet = "1.  2024 extended list of ports")  %>% 
                 rename(port = `Country/Port Name`, stat_port = `Statistical Port`, nat_stat_group = `Nat. Stat. Group`) %>%
                 filter(!is.na(nat_stat_group)) %>% select(nat_stat_group) %>% group_by(nat_stat_group) %>% summarize(count=n())

nat_stat_names <- read_xlsx("mar_esms_an_2.xlsx", sheet = "1.  2024 extended list of ports")  %>% 
                  rename(port = `Country/Port Name`, stat_port = `Statistical Port`) %>% 
                  select(port, UNLocode)

nat_stat_groups <- merge(nat_stat_groups, nat_stat_names, by.x = "nat_stat_group", by.y = "UNLocode", all.x = T)

through_put_2019 <- port_data %>% filter(year==2019) %>% group_by(port) %>%  summarize(container_2019=sum(container,na.rm=T))

nat_stat_groups <- merge(nat_stat_groups, through_put_2019, by.x="port", by.y = "port", all.x = T) %>% arrange(desc(count)) %>% 
  mutate(share = round(container_2019/count, digits = 0))

na_count_nat_stat_g <- sum(is.na(nat_stat_groups))

nat_stat_groups <- filter(nat_stat_groups, !is.na(container_2019))

```

```{r echo=FALSE}
kable(nat_stat_groups,
      caption = "National Statistical Groups combining many Ports")
```



## Distribution of throughput by ports and origin



```{r include=FALSE}
# top 50 ports
top50 <- port_data %>% filter(year>2010) %>% group_by(port) %>% summarise(throughput=sum(container, na.rm=T)) %>% ungroup() %>% 
         arrange(desc(throughput)) %>% head(n=50) %>% pull(port)

# top 50 ports with highest share of chinese goods
top50_china <- port_data %>% filter(year>2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & container>0),
                                                    throughput_others = case_when(china==1 ~ 0,
                                                                                  china==0 ~ container),
                                                    throughput_china = case_when(china==1 ~ container,
                                                                                 china==0 ~ 0)) %>%
         group_by(port) %>% summarise(throughput_others=sum(throughput_others, na.rm=T),
                                      throughput_china=sum(throughput_china, na.rm=T),
                                      share = throughput_china/throughput_others) %>% arrange(desc(share)) %>% 
         head(n=50) %>% pull(port)

```

Port that process a relatively high share of cargo from China are generally large ports. Below are displayed the top 50 largest ports, their aggregate throughput and their throughput of Chinese container shipments (Mainland China + Hong Kong). The other graph displays the top 50 ports with the highest share of Chinese container throughput. Both lists are quite similar with `r as.numeric(length(setdiff(top50,top50_china)))` large ports which are not among the top 50 ports with high Chinese container throughput. 

```{r echo=FALSE, warning=FALSE, message=FALSE}
port_data %>% filter(year>=2010, port %in% top50) %>%  mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & container>0)) %>%
              group_by(port, china) %>% summarise(throughput=sum(container, na.rm=T)) %>% ungroup() %>%  
              ggplot(aes(x=reorder(port,desc(throughput)), y=throughput, fill=china)) + 
              geom_bar(stat="identity", position = "stack") +
              labs(title="Container throughput of the 50 largest ports (2010-2023)", caption = "Blue bars represent throughput of chinese goods.")+
              theme(axis.text.x = element_text(angle = 45, hjust = 1),
                    axis.title.x = element_blank())

port_data %>% filter(year>=2010, port %in% top50_china) %>%  mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & container>0)) %>%
              group_by(port, china) %>% summarise(throughput=sum(container, na.rm=T)) %>% ungroup() %>%  
              ggplot(aes(x=reorder(port,desc(throughput)), y=throughput, fill=china)) + 
              geom_bar(stat="identity", position = "stack") +
              labs(title="Container throughput of the 50 ports with the highest share of chinese throughput (2010-2023)", caption = "Blue bars represent throughput of chinese goods.")+
              theme(axis.text.x = element_text(angle = 45, hjust = 1),
                    axis.title.x = element_blank())
```

```{r include=FALSE}
#china share
china_share <- port_data %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & container>0),
                                        throughput_others = case_when(china==1 ~ 0,
                                                                      china==0 ~ container),
                                        throughput_china = case_when(china==1 ~ container,
                                                                     china==0 ~ 0)) %>%
  group_by(year) %>% summarise(throughput_others=sum(throughput_others, na.rm=T),
                               throughput_china=sum(throughput_china, na.rm=T),
                               share = throughput_china/throughput_others*100*25000)

```
Above graphs indicate that the share of Chinese cargo is (surprisingly) low. The graph below plots the total cargo from China, the total cargo from origins other than China and the share of Chinese cargo in percent. Recent global crises, like the financial crisis in 2007-2009, the corona-pandemic in 2020, and the Ukraine war in 2023 have led to drops in total cargo shipments. Interestingly, they have affected Chinese cargo more than cargo from other origins, as the relative share of Chinese cargo mimics the movement of the total cargo shipments.

```{r echo=FALSE,message=FALSE}
port_data   %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & container>0)) %>%
                group_by(year, china) %>% summarise(throughput=sum(container, na.rm=T)) %>% ungroup() %>%
                ggplot(aes(x=year)) + 
                geom_line(aes(y=throughput, color = china)) +
                geom_line(data=china_share, aes(x=year,y=share)) + 
                scale_y_continuous(
                  name = "throughput",
                  sec.axis = sec_axis( trans=~./25000, name="share in percent")) + 
                labs(title = "Aggregate container throughput over time", 
                caption = "Blue line represents throughput of chinese goods. 
                           Red line represents throughput from all other countries.
                           Black line represents share in percent.") +
                theme(axis.title.y.right = element_text(angle = 90))

```



```{r echo=FALSE, message=FALSE}

port_data %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & container>0),
                     sender = case_when(china==0 ~ sender,
                                        china==1 ~ "China")) %>%
              group_by(sender) %>% summarize(throughput=sum(container, na.rm=T), china=max(china)) %>% ungroup() %>% 
              arrange(desc(throughput)) %>% head(n=50) %>%
              ggplot(aes(x=reorder(sender, desc(throughput)), y=throughput)) + 
              geom_bar(stat="identity", aes(fill=china)) +
              labs(title = "Top 50 origins of container shipments (2010-2023)") +
              theme(axis.text.x = element_text(angle = 45, hjust = 1),
                    axis.title.x = element_blank())
```

