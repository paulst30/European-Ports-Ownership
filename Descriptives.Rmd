---
title: "Descriptives"
author: "Paul Stricker"
date: "2023-11-21"
output: 
   html_document:
      keep_md: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(dplyr)
library(tidyr)
library(patchwork)
library(ggplot2)
library(ggpattern)
library(gt)
library(readxl)
library(knitr)
library(cowplot)
library(lattice)
library(extrafont)
library(xtable)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
#library(showtext)

loadfonts(device = "win")
#showtext_auto()

load("port_data.RData")
load("port_data_TEU.RData")

port_data <- filter(port_data, aggregate==0, stat_port==1) 
port_data_TEU <- filter(port_data_TEU, aggregate==0, stat_port==1)


# #add control variables
# wpi_data <- read.csv("WPI_data.csv")
# 
# port_data_TEU <- merge(port_data_TEU, wpi_data, by.x = "port_code", by.y="port_code", all.x = T)
```

# What is the relevant sample? 

## Which type of cargo?

Most throughput of energy commodities (transported in bulks) and Ro-Ro comes from countries other than China. The highest share of Chinese products is shipped with container cargo. Therefore, the sample is restricted to container cargo only.

```{r , echo=FALSE,message=FALSE}
theme_set(theme_minimal() + theme(legend.position = 'none'))

port_data %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)"))) %>%
  pivot_longer(cols = c("roro", "bulk", "container", "other"), names_to = "type", values_to = "throughput") %>%
  group_by(type, china) %>% summarize(throughput = sum(throughput, na.rm = T)) %>% 
  ggplot(aes(y=throughput, x=reorder(type, desc(throughput)))) + geom_bar(stat="identity", position = "stack", aes(fill = china) ) +
  xlab("cargo type") + 
  labs(title="Throughput by type", caption = "Blue bars represent cargo from China.")


```

## Container weight versus volume 

```{r echo=FALSE, warning=FALSE}
merge(port_data, port_data_TEU, by.x = c("port_code", "sender_code", "year", "quarter"), by.y = c("port_code", "sender_code", "year", "quarter")) %>% 
  select(container, total_TEU, empty_TEU) %>% 
  mutate(loaded_TEU = total_TEU-empty_TEU) %>%
  ggplot(aes(x=loaded_TEU, y=container)) + geom_point() +
  ylab("container throughput (thousand tonnes)") +
         xlab("container throughput (TEU)") +
         labs(title = "Container throughput: Weight versus volume (2000-2022)", caption = "Container throughput by TEU only includes loaded containers.") 


```

Container processing can be measured with two variables: Container weight or volume (TEU). Above graph shows, that the relation between the two is mostly linear. To make the results of our analysis more comparable to other studies and data sources, we will proceed using data on container TEUs. 


## Which ports are relevant? 

```{r include=FALSE}
through_put_by_ports <- port_data_TEU %>% filter(year>=2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") &                                          total_TEU>0)) %>%
                        group_by(port) %>% summarise(throughput=sum(total_TEU, na.rm=T), china=max(china), 
                                                     nat_stat_group = max(nat_stat_group),  
                                                     average_yrly=max(TEU_yrly)) %>% ungroup() %>%
                        mutate(throughput = throughput/sum(throughput)) %>% arrange(desc(throughput)) %>% 
                        mutate(cumsum=cumsum(throughput))
                        
```

Most of the throughput concentrates in a few hundred ports. Limiting the sample to `r sum(through_put_by_ports$cumsum<.99)` ports that are responsible for 99 percent of the container shipments might be a sensible option (`r sum(through_put_by_ports$nat_stat_group[through_put_by_ports$cumsum<.99])` of these are aggregates of ports). Additionally, not all ports process Chinese goods. While all major ports do, especially small ports usually do not. 

```{r echo=FALSE}

distribution_ports <- port_data_TEU %>% filter(year>=2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & total_TEU>0)) %>%
         group_by(port) %>% summarise(throughput=sum(total_TEU, na.rm=T), china=max(china, na.rm = T)) %>% ungroup() %>%
         mutate(throughput = throughput/sum(throughput)) %>% arrange(desc(throughput)) %>% mutate(n=row_number()) %>%
         ggplot( aes(x=n, y=cumsum(throughput))) + geom_point(aes(colour = china)) + 
         ylab("share of throughput") +
         xlab("number of ports") +
         #labs(title = "Cumulative container throughput by ports (2010-2023)") +
         theme_minimal() +
              theme(panel.background = element_blank(),
                    strip.text = element_text(hjust = 0, size=12),
                    text = element_text(size=14, family="LM Roman 10"),
                    legend.position = "none")

note <- ggdraw() + geom_text(aes(label="Note: Blue dots are ports that process Chinese containers. \nData source: Eurostat."), x = 0.05, y = 0, hjust = 0,vjust = -1, size = 5, family="LM Roman 10")

cum_thrpt <- plot_grid(distribution_ports, note, ncol = 1, rel_heights = c(0.85,0.15))
cum_thrpt
ggsave(width=12, height=7, filename = "cumulative_throughput_share.pdf", path = file.path(getwd(), "figures"))



```

```{r, include=F}
cut_offs <- port_data_TEU %>% filter(year>=2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") &                                          total_TEU>0)) %>%
                        group_by(port) %>% summarise(throughput=sum(total_TEU, na.rm=T), china=max(china), 
                                                     nat_stat_group = max(nat_stat_group),  
                                                     average_yrly = max(TEU_yrly)) %>% ungroup() %>%
                        mutate(throughput = throughput/sum(throughput)) %>% arrange(average_yrly) %>% 
                        mutate(cumsum=cumsum(throughput))

```


An alternative to filtering by the aggregated throughput could be filtering by the average throughput. The graph below display the cumulative total throughput relative to the average yearly throughput. The graph indicates that possible cut-off thresholds of 10, 20, and 30 thousand TEUs of yearly average container throughput are associated with a loss of `r round(max(cut_offs$cumsum[cut_offs$average_yrly<=10000])*100, digits = 1 )`, `r round(max(cut_offs$cumsum[cut_offs$average_yrly<=20000])*100, digits = 1 )`, and `r round(max(cut_offs$cumsum[cut_offs$average_yrly<=30000])*100, digits = 1 )` percent of the cumulative total container throughput. In the following, the sample is constructed by applying a threshold of 20 thousand TEUs of average yearly container throughput.  

```{r echo=FALSE,message=FALSE}


port_data_TEU %>% filter(year>=2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & total_TEU>0)) %>%
         group_by(port) %>% summarise(throughput=sum(total_TEU, na.rm=T), 
                                      china=max(china, na.rm = T),
                                      average_yrly = mean(TEU_yrly, na.rm=T)) %>% ungroup() %>%
         mutate(throughput = throughput/sum(throughput)) %>% arrange(average_yrly) %>% 
         ggplot( aes(x=average_yrly, y=cumsum(throughput))) + geom_point(aes(colour = china)) + 
         geom_vline(xintercept = 10000) +
         geom_vline(xintercept = 20000) +
         geom_vline(xintercept = 30000) +
         coord_cartesian(ylim=c(0,0.04), xlim=c(0,50000)) +
         ylab("cummulative share of throughput") +
         xlab("average yearly container throughput") +
         labs(title = "Possible cut-offs", caption = "Blue dots are ports that process chinese goods.")


```


```{r, include=FALSE}
port_data_TEU <- filter(port_data_TEU, TEU_yrly >=20000, port_code!="DEHAM") #exclude port that have an average yearly container throughput above 20000

port_data_agg <- port_data_TEU %>% group_by(port, port_code, period, reporter_code) %>% 
                               summarize(container = sum(total_TEU, na.rm=T),
                                         group = max(group),
                                         year = max(year),
                                         quarter = max(quarter),
                                         ownership_china = max(ownership_china)) %>% ungroup() %>%
                              group_by(port_code) %>% 
                              mutate(port_id = cur_group_id()) %>% ungroup()

#exclude Rotterdam
port_data_TEU$total_TEU[port_data_TEU$port_code=="NLRTM" & between(port_data_TEU$year,2011,2020)]<-NA
port_data_agg$container[port_data_agg$port_code=="NLRTM" & between(port_data_agg$year,2011,2020)]<-NA

# add terminal data to the data set
#terminal_data <- read_xlsx("port_manual_berth.xlsx")

load("berth_data.RData")
terminal_data <- berth_data
  
# add channel depth and cranes from World port index
wpi_data <- read.csv("WPI_data.csv")

# control variables
control_var <- merge(wpi_data, terminal_data, by.x="port_code",by.y="port_code", all = T) %>%
               select(port_code,
                      #ships, cosco_owned_ships,
                      year, quarter, quay_length, cranes,
                      cranes_fixed, cranes_mobile, 
                      cranes_floating, max_lift, 
                      cargo_depth, lat, long)


# merge with aggregated data
port_data_agg <- merge(port_data_agg, control_var, 
                       by.x = c("port_code", "year", "quarter"), 
                       by.y = c("port_code", "year", "quarter"), 
                       all.x = T) 

port_data_agg$cranes[port_data_agg$cranes==0] <- 1
port_data_agg$quay_length[port_data_agg$quay_length==0] <- 1

```

# Sample

## Descriptives

```{r include=FALSE}

# share of national statistical groups
share <- port_data_TEU %>% mutate(stat_port = stat_port*total_TEU,
                              nat_stat_group = nat_stat_group*total_TEU) %>%
                       summarize(stat_port = sum(stat_port, na.rm=T),
                                 nat_stat_group = sum(nat_stat_group, na.rm = T)) %>%
                       mutate(share = round(nat_stat_group/(stat_port)*100, digits = 1)) %>%
                       pull(share)

#number of reporting countries
n_reporter <- as.numeric(length(unique(port_data_TEU$reporter[!is.na(port_data_TEU$total_TEU)])))


# number of ports
n_ports <- as.numeric(length(unique(port_data_TEU$port[!is.na(port_data_TEU$total_TEU)])))

# number of sending countries
n_sender <- as.numeric(length(unique(port_data_TEU$sender[!is.na(port_data_TEU$total_TEU)])))

# years covered
start_year <- min(port_data_TEU$year)
end_year <- max(port_data_TEU$year)

# number of periods
n_quarters <- as.numeric(length(unique(port_data_TEU$time[!is.na(port_data_TEU$total_TEU)])))

# number of ports with zero throughput
n_ports_nz <- port_data_TEU %>% group_by(port) %>% 
              summarise(throughput = sum(total_TEU)) %>% 
              filter(throughput==0) %>% nrow() %>%
              as.numeric()

```


The statistical units in the Eurostat data are a mixed list of actual ports and grouped ports (statistical ports) and geographic areas, which represent aggregates of many ports. While the port groups "usually" have one port management, this cannot be assumed for everyone. In addition, statistical ports that represent a group of ports make up the majority of the container shipments (`r share` percent). The definition of the statistical units (statistical ports and geographic aggregates) can be found in the [metadata](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=uriserv:OJ.L_.2018.180.01.0029.01.ENG&toc=OJ:L:2018:180:FULL), and in the [annex](https://ec.europa.eu/eurostat/cache/metadata/Annexes/mar_esms_an_2.xlsx). As of now, the sample is restricted to statistical ports (no geographic aggregates). The remaining sample includes:

- `r n_reporter` reporting countries
- `r n_ports` ports 
- `r n_sender` origin countries
- `r end_year-start_year` years (`r start_year`-`r end_year`, covering `r n_quarters` quarters)

```{r include=F}
nat_stat_groups <- read_xlsx("mar_esms_an_2.xlsx", sheet = "1.  2024 extended list of ports")  %>% 
                 rename(port = `Country/Port Name`, stat_port = `Statistical Port`, nat_stat_group = `Nat. Stat. Group`) %>%
                 filter(!is.na(nat_stat_group)) %>% select(nat_stat_group) %>% group_by(nat_stat_group) %>% summarize(count=n())

nat_stat_names <- read_xlsx("mar_esms_an_2.xlsx", sheet = "1.  2024 extended list of ports")  %>% 
                  rename(port = `Country/Port Name`, stat_port = `Statistical Port`) %>% 
                  select(port, UNLocode)

nat_stat_groups <- merge(nat_stat_groups, nat_stat_names, by.x = "nat_stat_group", by.y = "UNLocode", all.x = T)

through_put_2019 <- port_data_TEU %>% filter(year==2019) %>% group_by(port) %>%  summarize(container_2019=sum(total_TEU,na.rm=T))

nat_stat_groups <- merge(nat_stat_groups, through_put_2019, by.x="port", by.y = "port", all.x = T) %>% arrange(desc(count)) %>% 
  mutate(share = round(container_2019/count, digits = 0))

na_count_nat_stat_g <- sum(is.na(nat_stat_groups))

nat_stat_groups <- filter(nat_stat_groups, !is.na(container_2019))

```

```{r echo=FALSE}
# kable(nat_stat_groups,
#       caption = "National Statistical Groups combining many Ports")
```



## Distribution of throughput by ports and origin



```{r include=FALSE}
# top 50 ports
top50 <- port_data_TEU %>% filter(year>2010) %>% group_by(port) %>% summarise(throughput=sum(total_TEU, na.rm=T)) %>% ungroup() %>% 
         arrange(desc(throughput)) %>% head(n=50) %>% pull(port)

# top 50 ports with highest share of chinese goods
top50_china <- port_data_TEU %>% filter(year>2010) %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & total_TEU>0),
                                                    throughput_others = case_when(china==1 ~ 0,
                                                                                  china==0 ~ total_TEU),
                                                    throughput_china = case_when(china==1 ~ total_TEU,
                                                                                 china==0 ~ 0)) %>%
         group_by(port) %>% summarise(throughput_others=sum(throughput_others, na.rm=T),
                                      throughput_china=sum(throughput_china, na.rm=T),
                                      share = throughput_china/throughput_others) %>% arrange(desc(share)) %>% 
         head(n=50) %>% pull(port)

```

Port that process a relatively high share of cargo from China are generally large ports. Below are displayed the top 50 largest ports, their aggregate throughput and their throughput of Chinese container shipments (Mainland China + Hong Kong). The other graph displays the top 50 ports with the highest share of Chinese container throughput. Both lists are rather similar with `r as.numeric(length(setdiff(top50,top50_china)))` large ports which are not among the top 50 ports with high Chinese container throughput. 

```{r echo=FALSE, warning=FALSE, message=FALSE}
port_data_TEU %>% filter(year>=2010, port %in% top50) %>%  mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & total_TEU>0)) %>%
              group_by(port, china) %>% summarise(throughput=sum(total_TEU, na.rm=T)) %>% ungroup() %>%  
              ggplot(aes(x=reorder(port,desc(throughput)), y=throughput, fill=china)) + 
              geom_bar(stat="identity", position = "stack") +
              labs(title="Container throughput of the 50 largest ports (2010-2023)", caption = "Blue bars represent throughput of chinese goods.")+
              theme(axis.text.x = element_text(angle = 45, hjust = 1),
                    axis.title.x = element_blank())

port_data_TEU %>% filter(year>=2010, port %in% top50_china) %>%  mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & total_TEU>0)) %>%
              group_by(port, china) %>% summarise(throughput=sum(total_TEU, na.rm=T)) %>% ungroup() %>%  
              ggplot(aes(x=reorder(port,desc(throughput)), y=throughput, fill=china)) + 
              geom_bar(stat="identity", position = "stack") +
              labs(title="Container throughput of the 50 ports with the highest share of chinese throughput (2010-2023)", caption = "Blue bars represent throughput of chinese goods.")+
              theme(axis.text.x = element_text(angle = 45, hjust = 1),
                    axis.title.x = element_blank())
```

```{r include=FALSE}
#china share
china_share <- port_data_TEU %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & total_TEU >0),
                                        throughput_others = case_when(china==1 ~ 0,
                                                                      china==0 ~ total_TEU),
                                        throughput_china = case_when(china==1 ~ total_TEU,
                                                                     china==0 ~ 0)) %>%
  group_by(year) %>% summarise(throughput_others=sum(throughput_others, na.rm=T),
                               throughput_china=sum(throughput_china, na.rm=T),
                               share = throughput_china/throughput_others*100*2500000)

```
Above graphs indicate that the share of Chinese cargo is (surprisingly) low. The graph below plots the total container shipments from China, the total container shipments from origins other than China and the share of Chinese containers in percent. Recent global crises, like the financial crisis in 2007-2009, the corona-pandemic in 2020, and the Ukraine war in 2023 have led to drops in total cargo shipments. Interestingly, despite the narrative of the ever increasing dependency on Chinese goods, the share of Chinese container shipments is on a declining path since 2012. 

```{r echo=FALSE,message=FALSE}
port_data_TEU   %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & total_TEU>0)) %>%
                group_by(year, china) %>% summarise(throughput=sum(total_TEU, na.rm=T)) %>% ungroup() %>%
                ggplot(aes(x=year)) + 
                geom_line(aes(y=throughput, color = china)) +
                geom_line(data=china_share, aes(x=year,y=share)) + 
                scale_y_continuous(
                  name = "throughput",
                  sec.axis = sec_axis( trans=~./2500000, name="share in percent")) + 
                labs(title = "Aggregate container throughput over time", 
                caption = "Blue line represents throughput of chinese goods. 
                           Red line represents throughput from all other countries.
                           Black line represents share in percent.") +
                theme(axis.title.y.right = element_text(angle = 90))

```



```{r echo=FALSE, message=FALSE}

port_data_TEU %>% mutate(china = ((sender == "Hong Kong" | sender == "China (except Hong Kong)") & total_TEU>0),
                     sender = case_when(china==0 ~ sender,
                                        china==1 ~ "China")) %>%
              group_by(sender) %>% summarize(throughput=sum(total_TEU, na.rm=T), china=max(china)) %>% ungroup() %>% 
              arrange(desc(throughput)) %>% head(n=50) %>%
              ggplot(aes(x=reorder(sender, desc(throughput)), y=throughput)) + 
              geom_bar(stat="identity", aes(fill=china)) +
              labs(title = "Top 50 origins of container shipments (2010-2023)") +
              theme(axis.text.x = element_text(angle = 45, hjust = 1),
                    axis.title.x = element_blank())
```

## Chinese ownership treatment

```{r include=FALSE}

length(unique(port_data_TEU$port_code[port_data_TEU$group!=0]))

```

Originally, we found 26 ports which were at some point at least partly owned by a Chinese company. The selected sample contains `r length(unique(port_data_TEU$port_code[port_data_TEU$group!=0]))` treated ports. Eight ports dropped out of the sample due to various reasons:

- One port does not report any data (Willebroek)
- One falls into an aggregate of many ports (Venlo, is included in an aggregate of 96 ports)
- One falls below the average throughput threshold of 20 million TEUs (Stockholm)
- Four ports were always treated (Duisburg, Felixtowe, Thamesport, Harwich)
- On is excluded due to being treated only very recently (Hamburg)

The following graph display all 18 treated ports and their annual container throughput as a share of their mean container throughput. The vertical lines indicate treatment time. Solid line represent the container throughput of the respective port. The dashed line represents the average throughput of the control group. Note that not all ports report the throughput for every period. This might influence the average.

```{r echo=FALSE, message=FALSE, warning=F, fig.dim = c(8, 14)}
treated_ports <- port_data_TEU %>% filter(group!=0) %>% 
                 group_by(port_code, time) %>% 
                 summarize(total_TEU = sum(total_TEU, na.rm=T)) %>% 
                 group_by(port_code) %>% summarise(max = max(total_TEU, na.rm=T)) %>% 
                 arrange(desc(max)) %>% pull(port_code)

plot_list <- list()

for (i in 1:length(treated_ports)){
  treatment_period <- unique(port_data_TEU$group[port_data_TEU$port_code==treated_ports[i]])
  treatment_time <- unique(port_data_TEU$time[port_data_TEU$period==treatment_period])
  port_name <- unique(port_data_TEU$port[port_data_TEU$port_code==treated_ports[i]])
  
  plot_list[[i]] <- port_data_TEU %>% filter(port_code==treated_ports[i] | group==0) %>% group_by(port_code, time) %>%
                                         summarize(sum = sum(total_TEU, na.rm=T),
                                                   ownership_china = max(ownership_china),
                                                   group = max(group),
                                                   year = max(year)) %>% 
                                                  #group_by(port_code) %>% 
                                                  #mutate(sum = sum / mean(sum, na.rm=T)) %>% 
                                                   group_by(group, time) %>% 
                                         summarize(count = n_distinct(port_code),
                                                   container = ifelse(port_code=="NLRTM" & between(year,2011,2020), NA, sum(sum, na.rm=T)/count),
                                                   ownership_china = max(ownership_china)) %>%
              ggplot(aes(x=time, y=container/1000)) + geom_line(aes(linetype=as.factor(group))) +
              geom_vline(xintercept = treatment_time) +
              scale_linetype_manual(values=c("dotted", "solid")) +
              labs(title = port_name ) +
              theme_minimal() +
              theme(panel.background = element_blank(),
                    strip.text = element_text(hjust = 0, size=12),
                    text = element_text(size=10, family="LM Roman 10"),
                    legend.position = "none",
                    axis.title.x = element_blank(),
                    axis.title.y = element_blank())
}

x.title <- ggdraw() + geom_text(aes(label="TEU (thousands)", angle = 90), x = 0.5, y = 0.5, hjust = 0.5, vjust = 1, size = 5, family="LM Roman 10")
y.title <- ggdraw() + geom_text(aes(label="Year"), x = 0.5, y = 0.5, hjust = 0.5, vjust = 1, size = 5, family="LM Roman 10")

note <- ggdraw() + geom_text(aes(label="Note: Vertical line indicates treatment timing.\nSource: Eurostat, own calculation."), x = 0.05, y = 0, hjust = 0,vjust = -1, size = 4, family="LM Roman 10")

legend <- get_legend(plot_list[[1]] + 
                       scale_linetype_discrete(labels=c( "treated", "average of untreated")) +
                       theme(legend.position="bottom", legend.title = element_blank()))

plots <- plot_grid(plotlist = plot_list, ncol=3, align = "hv") 

plots1 <- plot_grid(plots, y.title, legend,note, ncol=1, rel_heights = c(0.9,0.025, 0.025, 0.05) ) 
#plots1 <- plot_grid(plots1, note, ncol=1, rel_heights = c(0.975,0.025) ) 

plot_grid(x.title, plots1, ncol = 2, rel_widths = c(0.05,0.95))

ggsave(width=10, height=15, filename = "port_ts_graph.pdf", path = file.path(getwd(), "figures"))
```


```{r include=FALSE}
# Plot for presentation

plots <- plot_grid(plotlist = plot_list, ncol=6, align = "hv") 

plots1 <- plot_grid(plots, y.title, legend,note, ncol=1, rel_heights = c(0.9,0.025, 0.025, 0.05) ) 
#plots1 <- plot_grid(plots1, note, ncol=1, rel_heights = c(0.975,0.025) ) 

plot_grid(x.title, plots1, ncol = 2, rel_widths = c(0.05,0.95))

ggsave(width=17, height=10, filename = "port_ts_graph_presentation.pdf", path = file.path(getwd(), "results_tables_presentation"))


# just "interesting" ports
plot_list <- list()

for (i in 1:length(treated_ports)){
  treatment_period <- unique(port_data_TEU$group[port_data_TEU$port_code==treated_ports[i]])
  treatment_time <- unique(port_data_TEU$time[port_data_TEU$period==treatment_period])
  port_name <- unique(port_data_TEU$port[port_data_TEU$port_code==treated_ports[i]])
  
  plot_list[[i]] <- port_data_TEU %>% filter(port_code==treated_ports[i] | group==0) %>% group_by(port_code, time) %>%
                                         summarize(sum = sum(total_TEU, na.rm=T),
                                                   ownership_china = max(ownership_china),
                                                   group = max(group),
                                                   year = max(year)) %>% 
                                                  #group_by(port_code) %>% 
                                                  #mutate(sum = sum / mean(sum, na.rm=T)) %>% 
                                                   group_by(group, time) %>% 
                                         summarize(count = n_distinct(port_code),
                                                   container = ifelse(port_code=="NLRTM" & between(year,2011,2020), NA, sum(sum, na.rm=T)/count),
                                                   ownership_china = max(ownership_china)) %>%
              ggplot(aes(x=time, y=container/1000)) + geom_line(aes(linetype=as.factor(group))) +
              geom_vline(xintercept = treatment_time) +
              scale_linetype_manual(values=c("dotted", "solid")) +
              labs(title = port_name ) +
              theme_minimal() +
              theme(panel.background = element_blank(),
                    strip.text = element_text(hjust = 0, size=16),
                    text = element_text(size=16, family="LM Roman 10"),
                    legend.position = "none",
                    axis.title.x = element_blank(),
                    axis.title.y = element_blank())
}


plots <- plot_grid(plotlist = plot_list[c(1,2,3,7,10,12)], ncol=3, align = "hv") 

plots1 <- plot_grid(plots, y.title, legend,note, ncol=1, rel_heights = c(0.9,0.025, 0.025, 0.05) ) 
#plots1 <- plot_grid(plots1, note, ncol=1, rel_heights = c(0.975,0.025) ) 

plot_grid(x.title, plots1, ncol = 2, rel_widths = c(0.05,0.95))

ggsave(width=12, height=8, filename = "port_ts_graph_presentation_6.pdf", path = file.path(getwd(), "results_tables_presentation"))

```



```{r include=F}

# calculate summary statistics by group

#controls
share <- port_data_TEU %>% mutate(china = (sender_code=="CN_X_HK")) %>% group_by(port_code, china, period) %>%
                           summarize(container = sum(total_TEU, na.rm=T)) %>% 
                           pivot_wider(id_cols = c("port_code", "period"), 
                                       values_from = "container", 
                                       names_from = "china", 
                                       names_prefix = "china") %>%
                           mutate(share = ifelse(!is.na(chinaTRUE),chinaTRUE/(chinaFALSE+chinaTRUE)*100,0))

sumstat_controls <- port_data_agg %>% group_by(port_id) %>% mutate(treated=max(ownership_china)) %>% ungroup() %>%
                                      filter(treated==0, container!=0, 
                                             !is.na(quay_length) & !is.na(cranes) & !is.na(max_lift) & !is.na(cargo_depth)) %>%
                                      merge(share, 
                                            by.x = c("port_code", "period"), 
                                            by.y = c("port_code", "period"), 
                                            all.x = T) %>%
                                      arrange(port_id, period) %>%
                                      group_by(port_id) %>%
                                      summarize(across(c("container", "share", "quay_length", "cranes", "max_lift", "cargo_depth"), list(agrate = ~ (tail(.x,n=1)-head(.x,n=1))/(tail(period,n=1)-head(period,n=1)))),
                                                across(c("container", "share", "quay_length", "cranes", "max_lift", "cargo_depth"), ~ mean(.x, na.rm=T), .names="{col}_mean")) %>% 
                                      #filter(!is.nan(ships_mean), !is.nan(cargo_depth_mean))%>% 
                                      ungroup() %>% select(-port_id) %>%
                                      summarize(across(ends_with("mean"), mean, .names = "{col}"),
                                                across(ends_with("grate"),~ mean(.x,na.rm=T), .names = "{col}")) %>% 
                                      pivot_longer(cols = starts_with(c("container_", "share_", "quay_length_", "cranes_", "max_lift", "cargo_depth_")), 
                                                   names_to = c("vars", ".value"),
                                                   names_pattern = "(.*)_(.*)")
#treated 
sumstat_treated <- port_data_agg %>% group_by(port_id) %>% mutate(treated=max(ownership_china))  %>%
                                      filter(treated==1, container!=0) %>% 
                                       merge(share, 
                                            by.x = c("port_code", "period"), 
                                            by.y = c("port_code", "period"), 
                                            all.x = T) %>%
                                      arrange(port_id, period) %>%
                                      mutate(across(c("container","share", "quay_length", "cranes", "max_lift", "cargo_depth"), ~ mean(.x, na.rm=T), .names="{col}_mean")) %>%
                                      group_by(port_id, ownership_china) %>%
                                      summarize(across(c("container","share", "quay_length", "cranes", "max_lift", "cargo_depth"), list(agrate = ~ (tail(.x,n=1)-head(.x,n=1))/(tail(period,n=1)-head(period,n=1)))),
                                                across(c("container_mean","share_mean", "quay_length_mean", "cranes_mean", "max_lift_mean", "cargo_depth_mean"), ~ max(.x))) %>%
                                      group_by(ownership_china) %>% 
                                      summarize(across(ends_with("mean"), mean, .names = "{col}"),
                                                across(ends_with("grate"),~ mean(.x,na.rm=T), .names = "{col}")) %>%
                                      pivot_wider(names_from = "ownership_china", values_from = ends_with("grate"), names_glue = "{.value}{ownership_china}") %>% 
                                      pivot_longer(cols = starts_with(c("container_", "share_", "quay_length_", "cranes_", "max_lift_", "cargo_depth_")), 
                                                   names_to = c("vars", ".value"),
                                                   names_pattern = "(.*)_(.*)")

# number of ports for which controls are non missing
length(unique(port_data_agg$port_id[!is.na(port_data_agg$quay_length) & !is.na(port_data_agg$cranes) & !is.na(port_data_agg$max_lift) & !is.na(port_data_agg$cargo_depth)]))

#combine
sumstats <- merge(sumstat_controls, sumstat_treated, by=c("vars")) %>%
            mutate(across(c("mean.x","agrate","mean.y","agrate0","agrate1"), ~ format(round(.,digits=2), big.mark = ","))) %>%
            mutate(across(starts_with("agrate"),~ifelse(.x=="0","-",.x)))

sumstats <- sumstats[c(2,6,5,3,1,4),]

# rename
sumstats$vars[sumstats$vars == "share"] <- "china share"
sumstats$vars[sumstats$vars == "quay_length"] <- "quay length"
sumstats$vars[sumstats$vars == "cargo_depth"] <- "cargo depth"
sumstats$vars[sumstats$vars == "max_lift"] <- "max lift"
    

```

```{r include=TRUE}
# generate latex table

# Insert multirow cell into the appropriate position in the LaTeX code
addtorow <- list()
addtorow$pos <- list(nrow(sumstats))
addtorow$command <- c("\\hline \\hline \\multicolumn{6}{l}{\\shortstack[l]{\\small Note: $\\Delta$ refers to average quarterly changes. Ports recieved equal \\\\ weights in the calculation of means and average changes.\\\\ Source: Eurostat, WPI, own calculation.}}\\\\")

# Modify the LaTeX code
latex_code <- print.xtable(xtable(sumstats, caption = "Summary statistics"),
                           label = "tab:sumstats",
                           caption.placement = "top",
                           include.rownames = FALSE,
                           add.to.row = addtorow,
                           hline.after = c(-1,-1,0),
                           size = "\\begin{adjustbox}{max width=\\textwidth}")

latex_code <- gsub("\\\\end\\{tabular\\}", "\\\\end{tabular} \n \\\\end{adjustbox} \\\\label{tab_sumstats}", latex_code)
latex_code <- gsub("vars & mean.x & agrate & mean.y & agrate0 & agrate1"," & \\\\multicolumn{2}{c}{Control group [N=109]} & \\\\multicolumn{3}{c}{Treatment group [N=18]} \\\\\\\\\n \\\\cmidrule(lr){2-3} \\\\cmidrule(lr){4-6}  Var. & mean & $\\\\Delta$ & mean & $\\\\Delta$ [$t \\\\leq t^*$] & $\\\\Delta$ [$t>t^*$]", latex_code)

# Save modified LaTeX code to a .tex file
cat(latex_code, file = file.path(getwd(), "results_tables", "sumstats.tex"))


# generate a gt table
sumstats_gt <- gt(sumstats, rowname_col = "vars") |>
              tab_header(
                title = "Summary statistics") |>
              cols_label(
                mean.x="mean",
                agrate="av. delta",
                mean.y="mean",
                agrate0="av.delta (t<t*)",
                agrate1="av.delta (t>t*)"
              ) |>
              tab_spanner(label = "Control group",
                          columns = c("mean.x", "agrate")) |>
              tab_spanner(label = "Treated",
                          columns = c("mean.y", "agrate0", "agrate1")) |>
              sub_missing(columns = everything(),
                          rows = everything(),
                          missing_text = "") |>
              tab_footnote(footnote = "") |>
              tab_options(stub.border.width = 0,
                          table_body.hlines.width = 0
              )

sumstats_gt


```

```{r include=FALSE}
# add Port liner connectivity index

PLCI <- read.csv("PLCI_cleaned")
partner_region <- read_excel(file.path(getwd(),"partner_region.xlsx"))

# generate map 
european_ports <- port_data_agg %>% merge(PLCI, by.x = c("port_code", "year", "quarter"), by.y = c("port_code", "year", "quarter"), all.y=T) %>%
                                    merge(partner_region, by.x = "reporter_code", by.y="partner_code", all.x = T) %>%
                                    filter(year==2020 | year==2006, !is.na(lat), !is.na(long)) %>% group_by(port, partner_region ,year) %>%
                                    summarize(#container = sum(container),
                                              plci_value = mean(plci_value),
                                              lat = mean(lat),
                                              long = mean(long),
                                              ownership_china = max(ownership_china)) %>% group_by(port) %>%
                                    mutate(ownership_china=max(ownership_china)) %>%
                                    pivot_wider(names_from = year, values_from = plci_value, names_prefix = "y") %>%
                                    mutate(delta=y2020-y2006,
                                           growth=(y2020/y2006-1)*100,
                                           pos = as.factor(ifelse(delta>0,"PLCI increase", "PLCI decrease"))) %>% 
                                    filter(!is.na(pos)) %>% ungroup()

ave_NE <- european_ports %>% filter(partner_region=="NE") %>% summarize(mean_delta=round(mean(growth,na.rm=T),digits = 1)) %>% pull(mean_delta)
ave_SE <- european_ports %>% filter(partner_region=="SE") %>% summarize(mean_delta=round(mean(growth,na.rm=T),digits = 1)) %>% pull(mean_delta)


world <- ne_countries(scale = "medium", returnclass = "sf")    

# Create a ggplot object
ggmap_change <- ggplot(data=world) + geom_sf() +
            geom_point(data = european_ports, aes(x = long, y = lat, size = growth, shape=pos ), fill = ifelse(european_ports$pos=="PLCI increase","green4", "red3")) +
            geom_segment(aes(x = -18, y = 46, 
                             xend = 0, yend = 46), 
                             linetype = "dashed", color = "black") +  # Horizontal segment
            geom_segment(aes(x = 0, y = 46, 
                             xend = 28, yend = 51), 
                             linetype = "dashed", color = "black") +
            annotate("text", x=-17, y=59, label="North", family="LM Roman 10", hjust=0)+
            annotate("text", x=-17, y=58, label=paste0("~Delta==",ave_NE,"*'%'"),parse=T, family="LM Roman 10", hjust=0)+
            annotate("text", x=-17, y=45, label="South", family="LM Roman 10",hjust=0)+
            annotate("text", x=-17, y=44, label=paste0("~Delta==",ave_SE,"*'%'"),parse=T, family="LM Roman 10", hjust=0)+
            #geom_text(aes(x=-17, y=47, label="North", hjust=-0.5), color="black")+
            #geom_text(aes(x=-17,y=45, label="South", hjust=-0.5), color="black")+
            coord_sf(xlim = c(-18,28), ylim = c(31,60), expand = FALSE)  + 
            theme(legend.position = "bottom",
                  text = element_text(size=10, family="LM Roman 10"),
                  axis.title = element_blank(),
                  axis.text = element_blank(),
                  axis.ticks.x = element_blank(),
                  axis.ticks.length = unit(.1, "pt"),
                  axis.ticks.y = element_blank(),
                  panel.border = element_rect(color = "black", fill = NA, size = 1),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  panel.background = element_rect(fill = "grey98"),
                  plot.margin = margin(0, 0, 0, 0),
                  legend.background = element_rect(fill = "white"),
                  legend.box.background = element_rect(colour = "black")
                  )+
  scale_shape_manual(values=c(25,24)) +
  scale_fill_gradient(na.value="white",low = "grey80", high = "grey30")+
  guides(size = "none",
          shape = guide_legend(title = "",
                               override.aes = list(shape = c(25, 24),fill = c("red3","green4"))))



legend <- get_legend(ggmap_change)


```

```{r warning=F}
# plot

map <- ggdraw(ggmap_change+ theme(legend.position = "none")) + draw_plot(legend, x=0,y=-0.44)

note2 <- ggdraw() + geom_text(aes(label="Note: Size of the triangles indicate change in the Port Liner Connectivity Index (PLCI) in percent. \nData source: UNCTAD."), x = 0.21, y = 0, hjust = 0, vjust=-.55, size = 4, family="LM Roman 10")

plot_grid(map,note2, rel_heights = c(0.9,0.1), ncol = 1)
ggsave(width=12, height=7, filename = "map.pdf", path = file.path(getwd(), "figures"))


```

## Development of North and South European ports

```{r}
# load inflow data
load("port_data_TEU_in.RData")

# clean inflow data
port_data_TEU_in <- filter(port_data_TEU_in, aggregate==0,
                        stat_port==1,              #filter out non-stat ports (and geographic aggregates)
                        TEU_yrly >=10000) %>%           #filter out small ports
                        #port_code!="DEHAM") %>%    #exclude Hamburg due to very recent treatment
  mutate(s_china = ifelse(sender_code=="CN_X_HK" | sender_code=="HK", 1, 0)) %>%
  group_by(port_code, sender_code) %>%
  mutate(pair_id=cur_group_id()) %>% ungroup() %>%
  rename(container=total_TEU) 

# add region dummies
port_data_TEU_in <- port_data_TEU_in %>% merge(partner_region, by.x = "reporter_code", by.y="partner_code", all.x = T) %>%
                    merge(partner_region, by.x = "sender_code", by.y="partner_code", all.x = T) %>%
                  mutate(region = partner_region.x, partner_region = partner_region.y) 

# top ten most important ports
top_ten_graph <- port_data_TEU_in %>% filter(year==2019 | year==2008) %>% group_by(port, year) %>% 
                 summarize(container=sum(container, na.rm=T)) %>%
                 pivot_wider(names_from = "year", values_from = "container", names_prefix = "container_") %>%
                 ungroup() %>% 
                 mutate(across(starts_with("container_"), ~round(.x/sum(.x,na.rm=T)*100, digits = 1),.names = "share_{.col}")) %>% 
                 arrange(desc(container_2019)) %>% head(n=10) %>% 
                 pivot_longer(cols = c("share_container_2008", "share_container_2019"), 
                              names_to = "year", names_prefix = "share_container_", values_to = "container") %>%
                 mutate(year=factor(year)) %>%
                     ggplot(aes(x=container, y=reorder(port,container_2019), fill= year)) + 
                     geom_bar(stat = "identity",
                              position = position_dodge(width = .75),
                              width = .75,
                              color="black") + 
                     geom_text(aes(label=container, group=year),
                               position = position_dodge(width = .75), hjust=-.4, size=4,label.size=0, family="LM Roman 10") +
                     xlim(c(0,19))+
                     theme_minimal() + xlab("Share of total throughput (percent)") + labs(title="b) Top 10 largest ports in 2019") +
                     scale_fill_manual(values = c("2008" = "grey70", "2019" = "grey40"), name = "Year") +
                     theme(axis.title.y = element_blank(),
                           legend.title = element_blank(),
                           legend.position = "bottom",
                           plot.title = element_text(face = "bold"),
                            text = element_text(size=14, family="LM Roman 10")) 

#get legend
top_ten_legend <- get_legend(top_ten_graph)


# show evolution of NE and SE in a graph
total <- port_data_TEU_in %>% filter(year>1999, year<2021) %>% mutate(region= factor(region, levels=c("NE", "SE"), labels = c("North European Ports", "South European Ports"))) %>% group_by(region, year) %>% summarise(container=sum(container, na.rm = T)) %>% mutate(partner_region="Total")

CHN_investments <- data.frame(year=c(2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008,2009,2010,2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021),
                              investments=c(0,0,0,0,140, 0, 5, 100, 3940,0,0,0, 110, 610, 170, 830, 2000, 230, 180, 1670,0, 80)) %>%
                   mutate(cum_inv = cumsum(investments))


change_graph <- port_data_TEU_in %>% mutate(partner_region= ifelse(partner_region=="EX", "External", "Internal")) %>%
                     group_by(region, partner_region, year) %>% summarise(container=sum(container, na.rm = T)) %>% 
                     filter(year>1999 , year <2021) %>% select(year, partner_region, region, container) %>%
                     pivot_wider(values_from = container, names_from = region) %>%
                     mutate(gap = SE-NE,
                            partner_region=factor(partner_region, levels=c("Internal", "External"), labels=c("Internal gap", "External gap"))) %>%
                     ggplot(aes(x=year,y=container/1000000)) +
                     geom_bar_pattern(aes(y = gap / 1000000, pattern = partner_region), 
                     stat = "identity", 
                     position = "stack",
                     pattern_density = 0.4,
                     pattern_fill = "black", 
                     color = "black",
                     fill = "white",
                     pattern_angle = 45, 
                     pattern_spacing = 0.01)  +
                     geom_line(data= total, aes(linetype=region), linewidth=.7) +
                     geom_step(data=CHN_investments, aes(x=year,y=cum_inv/700, linetype="Investment stock"), linewidth=.7)+
                     xlim(c(1999,2021)) +
                     xlab("Year") + ylab("TEU (millions)") + labs(title="a) Container throughput and Chinese investment") +
                     scale_y_continuous(name = "TEU (mllions)",
                                        sec.axis = sec_axis( trans=~./1000*700, name="Investment stock (billion Euro)")) + 
                     scale_linetype_manual(name = "Legend",
                                          values = c("solid","dashed" , "dotted"),
                                          labels = c("North European Ports", "South Europen Ports", "Investment stock")) +
                     theme(legend.position = "bottom",
                           legend.title = element_blank(),
                           plot.title = element_text(face = "bold"),
                           axis.title.y.right = element_text(angle = 90),
                           text = element_text(size=14, family="LM Roman 10")) +
                           guides(linetype = guide_legend(nrow=2),
                                  pattern = guide_legend(nrow=2))
#get legend
change_legend <- get_legend(change_graph)

# contribution to catch up after 2009
catch_up <- port_data_TEU_in %>% filter(partner_region=="EX", (year==2009 | year==2019)) %>% group_by(region, sender_code, year) %>%
            summarize(container=sum(container)) %>%
            pivot_wider(values_from = "container", names_from = "year", names_prefix =   "container_") %>%
            mutate(across(starts_with("container"),~ ifelse(is.na(.),0,.)),
                   diff=container_2019-container_2009) %>%
            select(-starts_with("container") )%>%
            pivot_wider(values_from = "diff", names_from = "region", names_sep = "_") %>%
            mutate(diff=SE-NE) %>% arrange(desc(diff)) %>%
            mutate(sender_code=ifelse(sender_code=="CN_X_HK", "CN", sender_code),
                   catch_up = log(ifelse(diff>0 & SE>0, diff,NA)),
                   change_SE = log(ifelse(SE>0, SE, NA)))

# show growth contribution on world map
contribution_graph <- world %>% merge(catch_up, by.x="iso_a2", by.y="sender_code", all.x=T) %>%
          ggplot() + geom_sf(aes(fill=change_SE))  +
           scale_fill_continuous(low="grey90", high="grey60", 
                       guide="colorbar",na.value="white") + 
            labs(title="c) Origins of containers shipped to South European Ports") +
           theme(legend.position = "none",
                  text = element_text(size=14, family="LM Roman 10"),
                  plot.title = element_text(face = "bold", hjust=0.1),
                  axis.title = element_blank(),
                  axis.text = element_blank(),
                  axis.ticks.x = element_blank(),
                  axis.ticks.length = unit(.1, "pt"),
                  axis.ticks.y = element_blank(),
                  axis.line = element_blank(),
                  panel.border = element_blank(),
                  #panel.border = element_rect(color = "white", fill = NA, size = 1),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  panel.background = element_rect(fill = "white",color = NA),
                  plot.margin = margin(0, 0, 0, 0))

# notes
change_note <- ggdraw() + geom_text(aes(label="Note: Data includes inward container shipments only. \nNote to a): Lines represent total container throughput. Bars represent the gap between Southern European ports and Northern European \nports. Internal refers to container origins within the EU. External refers to container origins outside of the EU. Data on Chinese \ninvestments into European maritime infrastructure is taken from Ghiretti et al (2023). \nNote to c): Shading represents the absolute increase in container throughput in South European ports to and from \nthe partner countries between 2009 and 2019. Darker shades represent higher values. \nData source: Eurostat, Ghiretti et al (2023)."), x = 0, y = 0, hjust = 0, vjust=0, size = 5, family="LM Roman 10")

# #show catch up contribution on world map
# world %>% merge(catch_up, by.x="iso_a2", by.y="sender_code", all.x=T) %>%
#           ggplot() + geom_sf(aes(fill=catch_up)) + labs(title="Contribution to catch up of SE")

# putting it all together
upper_graph <- plot_grid(change_graph , top_ten_graph, ncol = 2, align = "h")

#save upper graph for presentation
upper_graph
ggsave(width=12, height=7, filename = "map_presentation.pdf", path = file.path(getwd(), "results_tables_presentation"))

plot_grid(upper_graph,contribution_graph,change_note, ncol = 1, rel_heights = c(0.46,0.46,0.08))

ggsave(width=12, height=15, filename = "map2.pdf", path = file.path(getwd(), "figures"))

```



## Data availability for treated ports

The DiD approach is sensible to missing data in the timeseries of treated units. In the best case, there are no missing values in each treated unit. There are two options to achieve this: First, trim the time horizon at the front an end to make sure all treated ports start and end at the same time. Second, missing values in the middle of the time series could be imputed. 

```{r echo=FALSE, message=FALSE, fig.dim = c(16,8)}
missingness_matrix <- port_data_agg %>% filter(group!=0) %>% mutate(missing=case_when(!is.na(container) & ownership_china==0 ~ 1,
                                                                                      !is.na(container) & ownership_china==1 ~2)) %>%
                        pivot_wider(id_cols = "period", names_from = "port", values_from = "missing", values_fill = 0) %>%
                        arrange(period) %>% select(-period)
missingness_matrix <- as.matrix(missingness_matrix)

levelplot(missingness_matrix)
```


