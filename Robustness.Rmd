---
title: "Robustness Checks"
author: "Paul Stricker"
bibliography: literature_list.bib
date: "2024-01-22"
output: 
 html_document:
      keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r include=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(patchwork)
library(ggplot2)
library(fixest)
library(did)
library(CInf)
library(gt)
library(readxl)
library(stringr)
library(cowplot)
library(xtable)
library(extrafont)

loadfonts(device = "win")

#load data
load("port_data_TEU.RData")


port_data_TEU <- filter(port_data_TEU, aggregate==0,
                                       stat_port==1,              #filter out non-stat ports (and geographic aggregates)
                                       TEU_yrly >=20000,          #filter out small ports
                                       port_code!="DEHAM") %>%    #exclude Hamburg due to very recent treatment
             mutate(s_china = ifelse(sender_code=="CN_X_HK" | sender_code=="HK", 1, 0)) %>%
             group_by(port_code, sender_code) %>%
             mutate(pair_id=cur_group_id()) %>% ungroup() %>%
             rename(container=total_TEU)

port_data_agg <- port_data_TEU %>% mutate(origin_china = ifelse(!is.na(container) & (sender_code=="CN_X_HK" | sender_code=="HK"),container,0)) %>%
                               group_by(port, port_code, period, reporter_code, year, quarter) %>% 
                               summarize(container = sum(container, na.rm=T),
                                         real_gdp_reporter = mean(real_gdp_reporter),
                                         origin_china = sum(origin_china),
                                         group = max(group),
                                         group_operation = max(group_operation),
                                         ownership_china = max(ownership_china),
                                         operation = max(operation)) %>% ungroup() %>%
                              group_by(port_code) %>% 
                              mutate(port_id = cur_group_id(),
                                     mean_container = mean(container, na.rm=T)) %>% ungroup()

port_data_agg_ny <- port_data_agg %>% filter(group!=0)

port_group_list <- port_data_agg %>% filter(group!=0) %>% group_by(group) %>%
                                     summarize(ports = toString(unique(port)))
port_group_list_op <- port_data_agg %>% filter(group_operation!=0) %>% group_by(group_operation) %>%
                                     summarize(ports = toString(unique(port))) %>% 
                                     rename(group = group_operation)
port_group_list <- rbind(port_group_list, port_group_list_op)
port_group_list <- port_group_list[!duplicated(port_group_list$group),]
port_group_list$ports <- paste(port_group_list$ports,paste("(", port_group_list$group, ")", sep = ""))

port_list <- port_data_agg %>% filter(group!=0) %>% group_by(port) %>% summarize(id = mean(port_id))


#exclude Rotterdam
port_data_TEU$container[port_data_TEU$port_code=="NLRTM" & between(port_data_TEU$year,2011,2020)]<-NA
port_data_agg$container[port_data_agg$port_code=="NLRTM" & between(port_data_agg$year,2011,2020)]<-NA

# add Cosco and Terminal data to the data set
terminal_data <- read_xlsx("terminal_throughput.xlsx")


# add quay length, cranes and other control variables
load("berth_data.RData")
wpi_data <- read.csv("WPI_data.csv")


# terminal_number <- read_xlsx("port_terminal_berth.xlsx") %>%
#                    filter(type == "General") %>%
#                    group_by(port_code, terminal) %>%
#                    summarize(no_berths=n()) %>%
#                    group_by(port_code) %>%
#                    summarize(no_terminal=n(),
#                              no_berths=sum(no_berths)) %>%
#                    ungroup() %>% 
#                    merge(read_xlsx(("port_manual_berth.xlsx")), all.x=T, all.y=T) %>%
#                    select(-port) %>%
#                    merge(read.csv("WPI_data.csv"), all.x=T, all.y=T)


terminal_data <- merge(port_data_agg, terminal_data, by.x = c("port_code", "year", "quarter"), by.y = c("port_code", "year", "quarter"), all.x = T) %>%
                 merge(berth_data, by.x = c("port_code", "year", "quarter"), by.y = c("port_code", "year", "quarter"), all.x = T) %>%
                 merge(wpi_data, by.x = c("port_code"), by.y = c("port_code"), all.x = T) %>%
                 mutate(port_code = case_when(port_code=="BEZEE" | port_code=="BEANR" ~ "BE003",
                                              port_code=="ESVLC" ~ "ESBIO",
                                              .default = port_code),
                        port = case_when(port_code=="BE003" ~ "Zeebrugge and Antwerp",
                                         port_code=="ESBIO" ~ "Valencia and Bilbao",
                                         .default = port.x),) %>% 
                 group_by(port_code, port, year, quarter, period) %>%
                 summarize(across(c(terminal_TEU, container,quay_length, cranes, cosco_cranes, cosco_length), ~sum(., na.rm=T), .names = "{.col}"),
                           across(c(max_lift, cargo_depth, group), ~max(.,na.rm=T), .names="{.col}")) %>%
                 mutate(terminal_TEU = ifelse(terminal_TEU==0, NA, terminal_TEU),
                        across(starts_with("cosco_") , ~ifelse(is.na(terminal_TEU), NA, .x))) %>%
                 group_by(port_code) %>%
                 mutate(treated=(sum(!is.na(terminal_TEU))>0),
                        terminal_TEU = terminal_TEU*1000,
                        change=container - lag(container),) %>% ungroup()


#exclude Rotterdam and Antwerp when data is unavailable
terminal_data$container[terminal_data$port_code=="NLRTM" & between(terminal_data$year,2011,2020)]<-NA
terminal_data <- terminal_data[!(terminal_data$port_code=="BE003" & terminal_data$year >=2022),]

#set graph theme
theme_set(theme_minimal() + theme(legend.position = 'none'))

### Control variables for DID ####
terminal_data$quay_length[terminal_data$quay_length==0] <- 100
terminal_data$cranes[terminal_data$cranes==0] <- 1


### Control variables for DID ####


controls <- c("cranes", "max_lift", "cargo_depth")
var_controls <- c("quay_length")


```


# Cosco terminal level robustness check

## Terminal-level Difference in Difference

In the previous estimations, we used port-level data to measure the effect of Chinese investments on port performance. While this approach allowed us to control for various confounding variables in the fixed effects approach and gave us a nearly exhaustive coverage for the difference in difference calculations, it also comes with a lack in precision. Most of the Chinese investments do not target the whole port, but just one operational unit (usually a terminal). Therefore, our results might be driven by other terminals, which are part of the respective port but are not owned by Chinese investors. Vice versa, potentially poor performance of non-chinese terminals might negatively affect the estimated treatment effect. To tackle this shortcoming, this robustness check explores the effect of Chinese investments using terminal-level throughput data. The terminal-level throughput data is published on the Cosco website and covers all investments terminals Cosco invested in overseas. (footnote: unfortunately, CMP and Hutison ports do not publish terminal-level throughput data. However, given that most of the significant effects were found for Cosco-controlled ports, this robustness check covers most of the relevant ports.) The graphs below display the terminal-level throughput reported by Coscos in relation to the total throughput of the respective port as reported by Eurostat. (footnote: Zeebruegge and Antwerp, and Bilbao and Valencia had to be combined due to Cosco's reporting practice) Clearly, besides Piraeus, none of the ports are fully under control of Cosco. In some cases, the throughput associated with Cosco's terminal only makes up a fraction of the total port throughput. 

```{r include=FALSE, warning=FALSE, message=FALSE}
# counterfactual <- terminal_data %>% filter(treated!=1) %>%
#                   group_by(period) %>%
#                   summarise(untreat_TEU_per_ship = mean(untreat_TEU_per_ship, na.rm=T),
#                             type="other") %>% ungroup()


graph_list <- list()
for (i in seq_along(unique(terminal_data$port_code[terminal_data$treated==1]))) {
  port_c <- unique(terminal_data$port_code[terminal_data$treated==1])[i]
  port_name <- terminal_data$port[match(port_c, terminal_data$port_code)]



graph_list[[i]] <- terminal_data %>% mutate(residual = ifelse(!is.na(terminal_TEU) & container!=0, container-terminal_TEU, container)) %>% 
                          pivot_longer(c("terminal_TEU", "residual"), names_to = "type", values_to = "throughput") %>% 
                          filter(port_code==port_c) %>%
                          ggplot(aes(x=period, y=throughput/1000, fill=type)) + 
                          geom_area() +
                          scale_y_continuous(
                            name="throughput") +
                          scale_fill_manual(values=c("grey50", "grey30"),
                                            labels=c( "total port", "cosco terminal")) +
                          labs(title=port_name) +
                          theme_minimal() +
                          theme(panel.background = element_blank(),
                                strip.text = element_text(hjust = 0, size=12),
                                text = element_text(size=10, family="LM Roman 10"),
                                legend.position = "none",
                                axis.title.x = element_blank(),
                                axis.title.y = element_blank())
}
```

```{r include=TRUE, message=FALSE, echo=FALSE, warning=FALSE, fig.dim = c(6, 9),fig.align = 'center'}


# plots <- plot_grid(plotlist = graph_list, ncol=2) 
# 
# note <- ggdraw() + draw_text("Note: The blue areas represent the throughput of Cosco's terminals.\n The red area represents the container throughput of other non-chinese terminals within the respective port.", x = 0.5, y = 0.5, hjust = 0.5, vjust = 1, size = 8)
# 
# plot_grid(title, plots, note, ncol = 1, rel_heights = c(0.1, 0.9)) 

x.title <- ggdraw() + geom_text(aes(label="TEU (millions)", angle = 90), x = 0.5, y = 0.5, hjust = 0.5, vjust = 1, size = 5, family="LM Roman 10")
y.title <- ggdraw() + geom_text(aes(label="Period"), x = 0.5, y = 0.5, hjust = 0.5, vjust = 1, size = 5, family="LM Roman 10")

#note <- ggdraw() + geom_text(aes(label="Note:"), x = 0.05, y = 0, hjust = 0,vjust = -1, size = 3, family="LM Roman 10")

legend <- get_legend(graph_list[[1]] + 
                       theme(legend.position="bottom", legend.title = element_blank()))

plots1 <- plot_grid(plotlist = graph_list, ncol=2, align = "hv") 

plots1 <- plot_grid(plots1, y.title, legend, ncol=1, rel_heights = c(0.925,0.05, 0.025) ) 
#plots1 <- plot_grid(plots1, note, ncol=1, rel_heights = c(0.975,0.025) ) 

plot_grid(x.title, plots1, ncol = 2, rel_widths = c(0.05,0.95))

ggsave(width=10, height=11, filename = "rob_ts_graph.pdf", path = file.path(getwd(), "figures"))
  
```




To pair Cosco's terminal-level data with our port-level data, we normalize the throughput by port size. Naturally, larger ports should have higher throughput and should have a higher capacity for growth. To make the port- and terminal-level data comparable, we consider the number of berths of each port (including berths used for passenger traffic), the number of berths that are predominantly used for container shippings, and the total number of container ships that can dock at containter terminal(s) (measured by quay length divided by 300m. For ports without quay length, the number of ships was guesstimated on google maps.). The graphs below illustrate how good each measure explains the container throughput of the ports in year 2020.  


```{r include=TRUE, warning=FALSE, echo=FALSE, message=FALSE, fig.align = 'center'}
graph_list <- list()
i<-0
for (level in c("container", "change")) {
  for (terminal in c("quay_length" ,"cranes")) {
  i <- i+1
  graph_list[[i]] <- ggplot(data=terminal_data[terminal_data$year==2020,], aes_string(y=level,x=terminal)) + 
                     geom_point() + 
                     geom_smooth(method = "lm", se=FALSE)
  }
}

title <- ggdraw() +
  draw_text("Different measures of port size, throughput in levels and first differences", x = 0.5, y = 0.5, hjust = 0.5, vjust = 1, size = 14)

plots <- plot_grid(plotlist = graph_list, ncol=2) 

note <- ggdraw() + draw_text("Note: Number of general berths are taken from Shipnext.com.\n The alternative measure for number of berths and the length in terms of large container ships is derived from Google satelite images\n and official quay length from port websites.", x = 0.5, y = 0.5, hjust = 0.5, vjust = 1, size = 8)

plot_grid(title, plots, note, ncol = 1, rel_heights = c(0.1, 0.9)) 

```

The graph above indicates that the length of the quay measured in container ship length best explains the port-level throughput. Therefore, we will normalize the terminal-level throughput of cosco-controlled terminals and the port-level throughput by the number of container ships that can dock at all container terminals. 




```{r include=FALSE, warning=FALSE, echo=FALSE}
# Construct the dataset for DiD 

#How many periods are allowed for adjustment process?
treatmentlag <- 1

robustness_cosco <- terminal_data %>% filter(!is.na(terminal_TEU)) %>% select(port_code, port, year, quarter, period, terminal_TEU, cosco_length, cosco_cranes, max_lift, cargo_depth) %>% rename(quay_length=cosco_length, cranes = cosco_cranes,
                        container=terminal_TEU) %>%
                 group_by(port_code) %>%
                 mutate(group=min(period)+1) %>% ungroup()

#manually add controls for Zeebrugge Antwerp
# robustness_cosco[robustness_cosco$port_code=="BE003", "max_lift"]<-12
# robustness_cosco[robustness_cosco$port_code=="BE003", "cargo_depth"]<-14

#control ports
control_ports <- terminal_data %>% filter(group==0 & !is.infinite(cargo_depth))  

# putting it all together
robustness_cosco <- rbind(robustness_cosco, control_ports[, colnames(robustness_cosco)])%>% group_by(port_code) %>%
                    mutate(port_id=cur_group_id())



port_group_list_rob <- robustness_cosco %>% filter(group!=0) %>% group_by(group) %>%
                                     summarize(ports = toString(unique(port)),
                                               id = mean(port_id))


attgt_rob <- simple_staggered_did(yname = "container",            #outcome variable
                tname = "period",                 #time variable
                idname = "port_id",                    #id for units (should be port_code*sender)
                gname = "group",                    #grouping variable for first treatment. Is zero for never treated units
                xformula = controls,
                varformula = var_controls,
                data = robustness_cosco)

#making a table
results <- data.frame(Estimate = c("simple average", port_group_list_rob$ports[match(as.character(attgt_rob$groupwise_treatment_effects$id), port_group_list_rob$id)]),
                       ATT = c(attgt_rob$average_treatment_effect$att,
                                   attgt_rob$groupwise_treatment_effects$att),
                       lower = c(attgt_rob$average_treatment_effect$att - attgt_rob$average_treatment_effect$crit_val,
                                attgt_rob$groupwise_treatment_effects$att - attgt_rob$groupwise_treatment_effects$crit_val),
                       upper = c(attgt_rob$average_treatment_effect$att + attgt_rob$average_treatment_effect$crit_val,
                                  attgt_rob$groupwise_treatment_effects$att + attgt_rob$groupwise_treatment_effects$crit_val)) %>%
               mutate(sig = (ATT>0 & lower>0) | (ATT<0 & upper<0),
                      across(c("ATT","lower","upper"), ~ format(round(.,digits=0), big.mark = ",")),
                      ATT = ifelse(sig==T, paste0(ATT, "*"), ATT),
                      Conf = paste0("[",str_trim(lower),"; ",str_trim(upper),"]"))

results <- results[c("Estimate", "ATT", "Conf")]

# make a gt table
results_gt_rob <- gt(results, rowname_col = "Estimate") |>
              tab_header(
                title = "Aggregation of group time average treatment effects",
                subtitle = "Control group: Never treated") |>
              cols_label(
                Conf="95% CI"
              ) |>
              tab_row_group(label = "by group:",
                            rows = c(2:7)) |>
              row_group_order(groups = c(NA,"by group:")) |>
              sub_missing(columns = everything(),
                          rows = everything(),
                          missing_text = "") |>
              tab_footnote(footnote = "Confidence intervals are based on bootstrapped errors.")


#generate Latex table
#add group row
results<- rbind(results[1,],c("by group", rep("", ncol(results)-1)) ,results[2:7,]) 


# Insert multirow cell into the appropriate position in the LaTeX code
addtorow <- list()
addtorow$pos <- list(nrow(results),1)
addtorow$command <- c("[2ex] \\hline \\hline \\multicolumn{3}{l}{\\shortstack[l]{Note: Stars indicate that the uniform confidence interval \\\\does not include zero.\\\\}}", 
                      "[1ex]")

# Modify the LaTeX code
latex_code <- print.xtable(xtable(results, caption = "Cosco terminal treatment effects"),
                           label = "tab:cosco_results",
                           caption.placement = "top",
                           include.rownames = FALSE,
                           add.to.row = addtorow,
                           hline.after = c(-1,-1,0, 2),
                           size = "\\begin{adjustbox}{max width=\\textwidth}")

latex_code <- gsub("Estimate & ATT & Conf"," & ATT & 95\\\\% CI ", latex_code)

latex_code <- gsub("\\\\end\\{tabular\\}", "\\\\end{tabular} \n \\\\end{adjustbox} \\\\label{tab:cosco_results}", latex_code)
latex_code <- gsub("by group", "\\\\emph{by group}", latex_code)
latex_code <- gsub("lll", "lcc", latex_code)

# Save modified LaTeX code to a .tex file
cat(latex_code, file = file.path(getwd(), "results_tables", "cosco_results.tex"))

```


```{r include=TRUE, echo=FALSE}
results_gt_rob

```

The main disadvantage of this robustness check is that it cannot provide any indication of the validity of the PTA, since there is no terminal-level data before the Chinese investment available. To circumvent this, the first period of the treatment is used as the untreated throughput of each treated terminal. This assumption might be reasonable, considering that it is unlikely to see stark changes in infrastructure and management just one quarter after the take-over. On the other side, some might argue that the first period might a unfitting comparison, as ther port needs some adjustment time to the management change. This would cause an upward bias in the results. Additionally, in some cases, it appears likely that the investment targeted a more productive terminal of the port, which would result in an selection bias. To counteract this, either more information on port equipment (cranes or storage) could be used to construct counterfactuals. 

## The role of Chinese Containers

The previous analysis has shown that ports controlled by Chinese investors outperform other comparable European ports. One possible explanation is, that Chinese owned ports are the preferred destination of the Chinese container ships. That fits well with the literature on (add cosco line paper, maybe investment selection? Ports owned by a chinese company with a own fleet grow more that others. Media reports on "foot in the door strategy"). In this extension, we look into how much of the port growth after Chinese investment is indeed caused by more container arriving from China. To investigate this question, we return to the bilateral port-level data from Eurostat and estimate two additional DiD. In the first, we again aggregate the container throughput on port-quarter level but exclude all container traffic with China Mainland and Hong Kong. In the second, we use the share of chinese containers relative to containers from other origins in each port as dependent variable. In the latter case, the identifying parallel trends assumption that needs to hold is that the relative throughput of Chinese containers in treated ports trend in the same way as the relative throughput of Chinese containers in untreated ports @Olden.2022. (footnote: This setup has a number of advantages over a simple difference in difference using Chinese container throughput in levels as the outcome variable. In particular, the triple difference setup helps reducing potential bias that could be in a difference in difference estimation of Chinese container throughput versus container throughput of other origins for treated ports and untreated ports.) With the help of these two setups, we can infer whether the growth in throughput has been carried primarily by Chinese container shipments and whether that growth came at the expense of container shipments from other origins. 


```{r include=F}

#### DiD without China ###
port_data_agg_woCHN <- port_data_TEU %>% mutate(origin_china = ifelse(!is.na(container) & (sender_code=="CN_X_HK" | sender_code=="HK"),container,0)) %>%
                                         filter(origin_china==0) %>%
                               group_by(port, port_code, period, reporter_code, year, quarter) %>% 
                               summarize(container = sum(container, na.rm=T),
                                         group = max(group)) %>% ungroup() %>%
                              group_by(port_code) %>% 
                              mutate(port_id = cur_group_id()) %>% ungroup() %>%
                              merge(berth_data, by.x = c("port_code", "year", "quarter"), by.y = c("port_code", "year", "quarter"), all.x = T) %>%
                              merge(wpi_data, by.x = c("port_code"), by.y = c("port_code"), all.x = T) 


#exclude Rotterdam
port_data_agg_woCHN$container[port_data_agg_woCHN$port_code=="NLRTM" & between(port_data_agg_woCHN$year,2011,2020)]<-NA

port_data_agg_woCHN$quay_length[port_data_agg_woCHN$quay_length==0] <- 100
port_data_agg_woCHN$cranes[port_data_agg_woCHN$cranes==0] <- 1


attgt_woCHN <- simple_staggered_did(yname = "container",            #outcome variable
                tname = "period",                 #time variable
                idname = "port_id",                    #id for units (should be port_code*sender)
                gname = "group",                    #grouping variable for first treatment. Is zero for never treated units
                xformula = controls,
                varformula = var_controls,
                control_group = "not_yet_treated",
                data = port_data_agg_woCHN)

# results table
results <- data.frame(Estimate = c("simple average", port_list$port[match(as.character(attgt_woCHN$groupwise_treatment_effects$id), port_list$id)]),
                       ATT = c(attgt_woCHN$average_treatment_effect$att,
                                   attgt_woCHN$groupwise_treatment_effects$att),
                       lower = c(attgt_woCHN$average_treatment_effect$att - attgt_woCHN$average_treatment_effect$crit_val,
                                attgt_woCHN$groupwise_treatment_effects$att - attgt_woCHN$groupwise_treatment_effects$crit_val),
                       upper = c(attgt_woCHN$average_treatment_effect$att + attgt_woCHN$average_treatment_effect$crit_val,
                                  attgt_woCHN$groupwise_treatment_effects$att + attgt_woCHN$groupwise_treatment_effects$crit_val),
                      p_value = c(NA, attgt_woCHN$groupwise_treatment_effects$pre_treatment_p_value)) %>%
               mutate(sig = (ATT>0 & lower>0) | (ATT<0 & upper<0),
                      pretest = (p_value < 0.05) & !is.na(p_value),
                      across(c("ATT","lower","upper"), ~ format(round(.,digits=0), big.mark = ",")),
                      ATT = ifelse(sig==T, paste0(ATT, "*"), ATT),
                      ATT = ifelse(pretest==T, paste0(ATT, "^{x}"),ATT),
                      Conf = paste0("[",str_trim(lower),"; ",str_trim(upper),"]"))

results <- results[c("Estimate", "ATT", "Conf")]


#### DiD with china share ####
port_data_agg <- mutate(port_data_agg, share_china=origin_china/(container)) 

attgt_share <- simple_staggered_did(yname = "share_china",            #outcome variable
                tname = "period",                 #time variable
                idname = "port_id",                    #id for units (should be port_code*sender)
                gname = "group",                    #grouping variable for first treatment. Is zero for never treated units
                data = port_data_agg)

# results table
results_share <- data.frame(Estimate = c("simple average", port_list$port[match(as.character(attgt_share$groupwise_treatment_effects$id), port_list$id)]),
                       ATT = c(attgt_share$average_treatment_effect$att,
                                   attgt_share$groupwise_treatment_effects$att),
                       lower = c(attgt_share$average_treatment_effect$att - attgt_share$average_treatment_effect$crit_val,
                                attgt_share$groupwise_treatment_effects$att - attgt_share$groupwise_treatment_effects$crit_val),
                       upper = c(attgt_share$average_treatment_effect$att + attgt_share$average_treatment_effect$crit_val,
                                  attgt_share$groupwise_treatment_effects$att + attgt_share$groupwise_treatment_effects$crit_val),
                       p_value = c(NA, attgt_share$groupwise_treatment_effects$pre_treatment_p_value)) %>%
               mutate(sig = (ATT>0 & lower>0) | (ATT<0 & upper<0),
                      pretest = (p_value < 0.05) & !is.na(p_value),
                      across(c("ATT","lower","upper"), ~ format(round(.,digits=4), big.mark = ",")),
                      ATT = ifelse(sig==T, paste0(ATT, "*"), ATT),
                      ATT = ifelse(pretest==T, paste0(ATT, "^{x}"),ATT),
                      Conf = paste0("[",str_trim(lower),"; ",str_trim(upper),"]"))

results_share <- results_share[c("Estimate", "ATT", "Conf")]

# combining results
results_final <- cbind(results, results_share[,c(2,3)]) 
colnames(results_final)[c(4,5)] <- c("ATT1","Conf1")



# putting together the results
results_gt_woCHN <- gt(results_final, rowname_col = "Estimate") |>
              tab_header(
                title = "Aggregated average treatment effects on container throughput from different origins",
                subtitle = "Control group: Never treated") |>
              cols_label(
                ATT="TEU without China",
                ATT1="Share of chinese TEU",
                Conf="95% CI",
                Conf1="95% CI") |>
              tab_stubhead(label = "Dependent variable:")|>
              tab_row_group(label = "by group:",
                            rows = c(2:19)) |>
              row_group_order(groups = c(NA,"by group:")) |>
              sub_missing(columns = everything(),
                          rows = everything(),
                          missing_text = "") |>
              tab_footnote(footnote = "Confidence intervals are based on bootstrapped errors. ")


#generate Latex table
#add group row
results_final <- rbind(results_final[1,],c("by group", rep("", ncol(results_final)-1)) ,results_final[2:19,]) 

# Insert multirow cell into the appropriate position in the LaTeX code
addtorow <- list()
addtorow$pos <- list(nrow(results_final),1)
addtorow$command <- c("[2ex] \\hline \\hline \\multicolumn{5}{l}{\\shortstack[l]{Note: Stars indicate that the uniform confidence interval does not include zero. \\\\ Superscript x indicates that we can reject the null of equal average pseudo \\\\ treatment effects between treated and untreated.}}", 
                      "[1ex]")

# Modify the LaTeX code
latex_code <- print.xtable(xtable(results_final, caption = "Aggregation of group time treatment effects without China"),
                           label = "tab:wochina_results",
                           caption.placement = "top",
                           include.rownames = FALSE,
                           add.to.row = addtorow,
                           hline.after = c(-1,-1,0, 2),
                           size = "\\begin{adjustbox}{max width=\\textwidth}")

latex_code <- gsub("Estimate & ATT & Conf & ATT1 & Conf1","Dependent var.: & \\\\multicolumn{2}{c}{TEU without China} & \\\\multicolumn{2}{c}{Share of Chinese TEU} \\\\\\\\\n \\\\cmidrule(lr){2-3} \\\\cmidrule(lr){4-5} PTA & Cond. & 95\\\\% CI & Uncond. & 95\\\\% CI" , latex_code)

latex_code <- gsub("\\\\end\\{tabular\\}", "\\\\end{tabular} \n \\\\end{adjustbox} \\\\label{tab:wochina_results}", latex_code)
latex_code <- gsub("by group", "\\\\emph{by group}", latex_code)
latex_code <- gsub("lllll", "lcccc", latex_code)
latex_code <- gsub("\\\\verb\\|\\^\\|\\\\\\{x\\\\\\}", "\\\\textsuperscript{x}", latex_code)

# Save modified LaTeX code to a .tex file
cat(latex_code, file = file.path(getwd(), "results_tables", "wochina_results.tex"))

```

```{r include =FALSE}
# table for presentation

results_presentation <- results_final[,c(1,2,4)]

# Insert multirow cell into the appropriate position in the LaTeX code
addtorow <- list()
addtorow$pos <- list(nrow(results_final),1)
addtorow$command <- c("[2ex] \\hline \\hline \\multicolumn{3}{l}{\\shortstack[l]{Note: Stars indicate that the uniform confidence interval does not include zero. \\\\ Superscript x indicates that we can reject the null of equal average pseudo \\\\ treatment effects between treated and untreated.}}", 
                      "[1ex]")

# Modify the LaTeX code
latex_code <- print.xtable(xtable(results_presentation),
                           label = "tab:wochina_results",
                           caption.placement = "top",
                           include.rownames = FALSE,
                           add.to.row = addtorow,
                           hline.after = c(-1,-1,0, 2),
                           size = "\\begin{adjustbox}{max width=\\textwidth}")

latex_code <- gsub("Estimate & ATT & ATT1","Dependent var.: & \\\\multicolumn{1}{c}{TEU without China} & \\\\multicolumn{1}{c}{Share of Chinese TEU} \\\\\\\\\n \\\\cmidrule(lr){2-2} \\\\cmidrule(lr){3-3} PTA & Cond. & Uncond." , latex_code)

latex_code <- gsub("\\\\end\\{tabular\\}", "\\\\end{tabular} \n \\\\end{adjustbox} \\\\label{tab:wochina_results}", latex_code)
latex_code <- gsub("by group", "\\\\emph{by group}", latex_code)
latex_code <- gsub("lll", "lcc", latex_code)
latex_code <- gsub("\\\\verb\\|\\^\\|\\\\\\{x\\\\\\}", "\\\\textsuperscript{x}", latex_code)

# Save modified LaTeX code to a .tex file
cat(latex_code, file = file.path(getwd(), "results_tables_presentation", "wochina_results_presentation.tex"))


```


```{r include=T, echo=FALSE}

results_gt_woCHN
```

# References
