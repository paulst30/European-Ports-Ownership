---
title: "Reshufffling descriptives"
author: "Katja Kalkschmied"
date: "2024-02-22"
output: html_document
---

```{r include=FALSE}
library(dplyr)
library(writexl)
library(readxl)
library(ggplot2)
library(echoice2)
library(doBy)
library(zoo)


load("port_data_TEU.RData")
load("port_data_TEU_in.RData")
load("port_data_TEU_out.RData")

port_data_TEU <- filter(port_data_TEU, aggregate==0,
                        stat_port==1,              #filter out non-stat ports (and geographic aggregates)
                        TEU_yrly >=20000,          #filter out small ports
                        port_code!="DEHAM") %>%    #exclude Hamburg due to very recent treatment
  mutate(s_china = ifelse(sender_code=="CN_X_HK" | sender_code=="HK", 1, 0)) %>%
  group_by(port_code, sender_code) %>%
  mutate(pair_id=cur_group_id()) %>% ungroup() %>%
  rename(container=total_TEU) %>%
  rename(partner_code=sender_code) %>%
  rename(partner=sender)



port_data_TEU_in <- filter(port_data_TEU_in, aggregate==0,
                        stat_port==1,              #filter out non-stat ports (and geographic aggregates)
                        TEU_yrly >=10000,          #filter out small ports
                        port_code!="DEHAM") %>%    #exclude Hamburg due to very recent treatment
  mutate(s_china = ifelse(sender_code=="CN_X_HK" | sender_code=="HK", 1, 0)) %>%
  group_by(port_code, sender_code) %>%
  mutate(pair_id=cur_group_id()) %>% ungroup() %>%
  rename(container=total_TEU) 



port_data_TEU_out <- filter(port_data_TEU_out, aggregate==0,
                        stat_port==1,              #filter out non-stat ports (and geographic aggregates)
                        TEU_yrly >=10000,          #filter out small ports
                        port_code!="DEHAM") %>%    #exclude Hamburg due to very recent treatment
  mutate(s_china = ifelse(sender_code=="CN_X_HK" | sender_code=="HK", 1, 0)) %>%
  group_by(port_code, sender_code) %>%
  mutate(pair_id=cur_group_id()) %>% ungroup() %>%
  rename(container=total_TEU) %>%
  rename(receiver_code=sender_code) %>%
  rename(receiver=sender)

# I set the filter for one-directional flows to 10000, that is half of what we use for the bi-directional flow sample.

summary(port_data_TEU$container, na.rm=TRUE)
summary(port_data_TEU_in$container, na.rm=TRUE)
summary(port_data_TEU_out$container, na.rm=TRUE)
```

<!-- get lists of partner_codes and reporter_codes-->

```{r include=FALSE}

listpartner <- port_data_TEU %>%
  group_by(partner_code) %>%
  slice(1) %>%
  ungroup() %>%
  select(partner_code, partner)


listreporter <- port_data_TEU %>%
  group_by(reporter_code) %>%
  slice(1) %>%
  ungroup() %>%
  select(reporter_code, reporter)

write_xlsx(listpartner, "listpartner.xlsx")

partner_region <- read_xlsx("partner_region.xlsx", sheet = "Sheet1")

reporter_region <- merge(listreporter, partner_region, by.x = "reporter_code", by.y = "partner_code", all.x = T) %>% 
  select(reporter_code, partner_region) %>% 
  rename("reporter_region" = "partner_region")
```

<!-- add region information of partner and reporter to TOTAL dataset-->

```{r include=FALSE}

port_data_TEU <- merge(port_data_TEU,partner_region, by = "partner_code") %>%
  relocate(partner_region, .after = partner_code)


port_data_TEU <- merge(port_data_TEU,reporter_region, by = "reporter_code") %>%
  relocate(reporter_region, .after = reporter_code) 

port_data_TEU$NENE_region <- ifelse(port_data_TEU$reporter_region == 'NE' & port_data_TEU$partner_region == 'NE', 1, 0)
sum(port_data_TEU$NENE_region)

port_data_TEU$SESE_region <- ifelse(port_data_TEU$reporter_region == 'SE' & port_data_TEU$partner_region == 'SE', 1, 0)
sum(port_data_TEU$SESE_region)

port_data_TEU$NESE_region <- ifelse(port_data_TEU$reporter_region == 'NE' & port_data_TEU$partner_region == 'SE', 1, 0)
sum(port_data_TEU$NESE_region)

port_data_TEU$SENE_region <- ifelse(port_data_TEU$reporter_region == 'SE' & port_data_TEU$partner_region == 'NE', 1, 0)
sum(port_data_TEU$SENE_region)

port_data_TEU$NEEX_region <- ifelse(port_data_TEU$reporter_region == 'NE' & port_data_TEU$partner_region == 'EX', 1, 0)
sum(port_data_TEU$NEEX_region)

port_data_TEU$SEEX_region <- ifelse(port_data_TEU$reporter_region == 'SE' & port_data_TEU$partner_region == 'EX', 1, 0)
sum(port_data_TEU$SEEX_region)

region_pair <- ec_undummy(port_data_TEU, c('NENE_region', 'SESE_region', 'NESE_region', 'SENE_region','NEEX_region','SEEX_region'), "region_pair", ref_level = "What") %>%
  select(port_code, partner_code, region_pair, year, quarter) 

port_data_TEU <- merge(port_data_TEU,region_pair, by.x=c("port_code", "partner_code", "year", "quarter"), by.y=c("port_code", "partner_code", "year", "quarter"))

list_port_by_size <- port_data_TEU %>%
  group_by(port) %>%
  summarise_at(vars(container), list(container_sum = sum), na.rm=T) %>%
  arrange(desc(container_sum))
```

<!-- add region information of sender and reporter to INFLOW dataset-->

```{r include=FALSE}

port_data_TEU_in <- merge(port_data_TEU_in,partner_region, by.x = "sender_code", by.y = "partner_code", all.x = T) %>%
  relocate(partner_region, .after = sender_code) %>%
  rename(sender_region=partner_region)
  
port_data_TEU_in <- merge(port_data_TEU_in,reporter_region, by = "reporter_code", all.x = T) %>%
  relocate(reporter_region, .after = reporter_code) 

port_data_TEU_in$NENE_region <- ifelse(port_data_TEU_in$reporter_region == 'NE' & port_data_TEU_in$sender_region == 'NE', 1, 0)
sum(port_data_TEU_in$NENE_region)

port_data_TEU_in$SESE_region <- ifelse(port_data_TEU_in$reporter_region == 'SE' & port_data_TEU_in$sender_region == 'SE', 1, 0)
sum(port_data_TEU_in$SESE_region)

port_data_TEU_in$NESE_region <- ifelse(port_data_TEU_in$reporter_region == 'NE' & port_data_TEU_in$sender_region == 'SE', 1, 0)
sum(port_data_TEU_in$NESE_region)

port_data_TEU_in$SENE_region <- ifelse(port_data_TEU_in$reporter_region == 'SE' & port_data_TEU_in$sender_region == 'NE', 1, 0)
sum(port_data_TEU_in$SENE_region)

port_data_TEU_in$NEEX_region <- ifelse(port_data_TEU_in$reporter_region == 'NE' & port_data_TEU_in$sender_region == 'EX', 1, 0)
sum(port_data_TEU_in$NEEX_region)

port_data_TEU_in$SEEX_region <- ifelse(port_data_TEU_in$reporter_region == 'SE' & port_data_TEU_in$sender_region == 'EX', 1, 0)
sum(port_data_TEU_in$SEEX_region)

region_pair <- ec_undummy(port_data_TEU_in, c('NENE_region', 'SESE_region', 'NESE_region', 'SENE_region','NEEX_region','SEEX_region'), "region_pair", ref_level = "What") %>%
  select(port_code, sender_code, region_pair, year, quarter) 

port_data_TEU_in <- merge(port_data_TEU_in,region_pair, by.x=c("port_code", "sender_code", "year", "quarter"), by.y=c("port_code", "sender_code", "year", "quarter"))
```

<!-- add region information of sender and reporter to OUTFLOW dataset-->

```{r include=FALSE}

port_data_TEU_out <- merge(port_data_TEU_out,partner_region, by.x = "receiver_code", by.y = "partner_code", all.x = T) %>%
  relocate(partner_region, .after = receiver_code) %>%
  rename(receiver_region=partner_region)
  
port_data_TEU_out <- merge(port_data_TEU_out,reporter_region, by = "reporter_code", all.x = T) %>%
  relocate(reporter_region, .after = reporter_code) 

port_data_TEU_out$NENE_region <- ifelse(port_data_TEU_out$reporter_region == 'NE' & port_data_TEU_out$receiver_region == 'NE', 1, 0)
sum(port_data_TEU_out$NENE_region)

port_data_TEU_out$SESE_region <- ifelse(port_data_TEU_out$reporter_region == 'SE' & port_data_TEU_out$receiver_region == 'SE', 1, 0)
sum(port_data_TEU_out$SESE_region)

port_data_TEU_out$NESE_region <- ifelse(port_data_TEU_out$reporter_region == 'NE' & port_data_TEU_out$receiver_region == 'SE', 1, 0)
sum(port_data_TEU_out$NESE_region)

port_data_TEU_out$SENE_region <- ifelse(port_data_TEU_out$reporter_region == 'SE' & port_data_TEU_out$receiver_region == 'NE', 1, 0)
sum(port_data_TEU_out$SENE_region)

port_data_TEU_out$NEEX_region <- ifelse(port_data_TEU_out$reporter_region == 'NE' & port_data_TEU_out$receiver_region == 'EX', 1, 0)
sum(port_data_TEU_out$NEEX_region)

port_data_TEU_out$SEEX_region <- ifelse(port_data_TEU_out$reporter_region == 'SE' & port_data_TEU_out$receiver_region == 'EX', 1, 0)
sum(port_data_TEU_out$SEEX_region)

region_pair <- ec_undummy(port_data_TEU_out, c('NENE_region', 'SESE_region', 'NESE_region', 'SENE_region','NEEX_region','SEEX_region'), "region_pair", ref_level = "What") %>%
  select(port_code, receiver_code, region_pair, year, quarter) 

port_data_TEU_out <- merge(port_data_TEU_out,region_pair, by.x=c("port_code", "receiver_code", "year", "quarter"), by.y=c("port_code", "receiver_code", "year", "quarter"))
```

# Descriptives for Reshuffling: Total (n=388,841)

<!-- Data manipulation work -->

```{r include=FALSE}
port_data_agg <- port_data_TEU %>% mutate(origin_china = ifelse(!is.na(container) & (partner_code=="CN_X_HK" | partner_code=="HK"),container,0)) %>%
  group_by(port, port_code, period, reporter_code) %>% 
  summarize(container = sum(container, na.rm=T),
            real_gdp_reporter = mean(real_gdp_reporter),
            origin_china = sum(origin_china),
            group = max(group),
            group_operation = max(group_operation),
            ownership_china = max(ownership_china),
            operation = max(operation)) %>% ungroup() %>%
  group_by(port_code) %>% 
  mutate(port_id = cur_group_id(),
         mean_container = mean(container, na.rm=T)) %>% ungroup()
         
port_group_list <- port_data_agg %>% filter(group!=0) %>% group_by(group) %>%
  summarize(ports = toString(unique(port)))

port_group_list_op <- port_data_agg %>% filter(group_operation!=0) %>% group_by(group_operation) %>%
                                     summarize(ports = toString(unique(port))) %>% 
                                     rename(group = group_operation)
port_group_list <- rbind(port_group_list, port_group_list_op)
port_group_list <- port_group_list[!duplicated(port_group_list$group),]
port_group_list$ports <- paste(port_group_list$ports,paste("(", port_group_list$group, ")", sep = ""))


subsample <- subset(port_data_TEU, partner_region == "SE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_south" = "container")

port_data_agg_final <- merge(port_data_agg,subsample, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_south = ifelse(is.na(container_south), 0, container_south)) %>%
  mutate(fraction_south_container = container_south/container)

mean(port_data_agg_final$fraction_south_container, na.rm=T)
max(port_data_agg_final$fraction_south_container, na.rm=T)
min(port_data_agg_final$fraction_south_container, na.rm=T)

subsample2 <- subset(port_data_TEU, partner_region == "EX" | partner_region == "NE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_other" = "container") 

port_data_agg_final <- merge(port_data_agg_final,reporter_region, by = "reporter_code") %>%
  relocate(reporter_region, .after = reporter_code) 

port_data_agg_final <- merge(port_data_agg_final,subsample2, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_other = ifelse(is.na(container_other), 0, container_other)) %>%
  mutate(container_total = container_other + container_south)

port_data_agg_final <- mutate(port_data_agg_final, fraction_china_container=origin_china/(container)) 

port_data_agg_final$SE <- ifelse(port_data_agg_final$reporter_region == 'SE', 1, 0)
mean(port_data_agg_final$SE)

subsample3 <- subset(port_data_TEU, partner_region == "NE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_north" = "container")

port_data_agg_final <- merge(port_data_agg_final,subsample3, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_north = ifelse(is.na(container_north), 0, container_north)) %>% 
  mutate(fraction_north_container = container_north/container) 

port_data_agg_final <- port_data_agg_final %>%
  mutate(container_south_2=ifelse(container_south == 0, 1, container_south)) %>%
  mutate(container_north_2=ifelse(container_north == 0, 1, container_north)) %>%
  mutate(fraction_south_north = container_south_2/container_north_2)
```

## total container throughput per region_pair
```{r echo=FALSE, warning=FALSE}
port_data_TEU %>%
  group_by(region_pair) %>%
  summarise_at(vars(container), list(container_sum = sum), na.rm=T) %>%
  arrange(desc(container_sum))

```

Note: all French ports now count as Norhtern European ports, including Marseille which maybe rather Should be classified as Southern European port. To discuss!

## Mean fractions of partners from total throughput per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_south_container), list(fraction_south_container = mean), na.rm=T)

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_north_container), list(fraction_north_container = mean), na.rm=T)

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_china_container), list(fraction_china_container = mean), na.rm=T)
```


## Development mean south container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

southfraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_southfraction=mean(fraction_south_container, na.rm=T))

ggplot(data=southfraction, aes(x=period, y=average_southfraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of south fraction")
```

## Development mean north container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

northfraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_northfraction=mean(fraction_north_container, na.rm=T))

ggplot(data=northfraction, aes(x=period, y=average_northfraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of north fraction")
```

## Development mean CH container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

chinafraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_chinafraction=mean(fraction_china_container, na.rm=T))

ggplot(data=chinafraction, aes(x=period, y=average_chinafraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of china fraction")
```


## Share of total container throughput over region pairs: TEU 1997-2023
```{r echo=FALSE, warning=FALSE}
throughput_development_regionpair_total <- port_data_TEU %>% group_by(region_pair) %>% summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  arrange(desc(throughput)) %>% mutate(fraction = round(throughput/sum(throughput)*100))

ggplot(throughput_development_regionpair_total, aes(x="", y=fraction, fill=region_pair))+
  geom_bar(stat="identity", color="black")+
  coord_polar("y")+
  theme_void()+
  scale_fill_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  geom_label(aes(label=fraction),
             position = position_stack(vjust = 0.5),
             color="black",
             label.size = 0,
             size=6,
             show.legend = FALSE)+
  labs(caption = "In Percent of total container throughput.")
# 51% of total throughput takes place in north ports, 8% between North and South in equal shares with respect to direction, 40% takes place in South ports.
```

55 % of the total containers handled in European ports 1997-2023 came or went to extra-European places. 

36% of total containers handled were subject to intra-regional trade.

8% of total containers handled were subject to inter-regional trade within Europe. The direction of flows from South to North and back was balanced.

### Development of total throughputs per region pair over years

```{r echo=FALSE, warning=FALSE, message=FALSE}
throughput_development_regionpair_year <- port_data_TEU %>% 
  group_by(region_pair, year) %>% 
  summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(year) %>%
  mutate(fraction = (throughput/sum(throughput)*100))

throughput_development_regionpair_yearquater <- port_data_TEU %>% group_by(region_pair, year, quarter, period) %>% summarise(throughput=sum(container, na.rm=TRUE))  %>% 
  arrange(desc(throughput))

throughput_development_regionpair_yearquater$yq <- as.yearqtr(paste0(throughput_development_regionpair_yearquater$year, "-", throughput_development_regionpair_yearquater$quarter))

ggplot(data=throughput_development_regionpair_year, aes(x=year, y=throughput, group=region_pair))+
  geom_line(aes(color=region_pair))+
  scale_color_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  labs(title = "Line chart - yearly data")

# plot for quaters
ggplot(data=throughput_development_regionpair_yearquater, aes(x= yq, y=throughput, group=region_pair))+
  geom_line(aes(color=region_pair))+
  scale_color_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  labs(title = "Line chart - quarterly data")

throughput_development_regionpair_year$group <- factor(throughput_development_regionpair_year$region_pair, levels=c("NEEX_region", "NENE_region", "SEEX_region", "SESE_region", "SENE_region", "NESE_region"))

ggplot(throughput_development_regionpair_year, aes(x=year, y=fraction, fill=group)) + 
  geom_area( size=0.5, colour="black")+
  scale_fill_manual(values = c("darkblue", "blue", "orange", "red", "yellow", "green"))+
  labs(title = "Area chart")
  
```

After the financial crisis, which coincides with the Chinese investment in Piraeus, container throughput of Southern European countries grew rapidly with extra-European partner countries and within the Southern region.


# Descriptives for Reshuffling: Inflows (n=298,407)

<!-- Data manipulation work -->

```{r include=FALSE}
port_data_agg <- port_data_TEU_in %>% mutate(origin_china = ifelse(!is.na(container) & (sender_code=="CN_X_HK" | sender_code=="HK"),container,0)) %>%
  group_by(port, port_code, period, reporter_code) %>% 
  summarize(container = sum(container, na.rm=T),
            real_gdp_reporter = mean(real_gdp_reporter),
            origin_china = sum(origin_china),
            group = max(group),
            group_operation = max(group_operation),
            ownership_china = max(ownership_china),
            operation = max(operation)) %>% ungroup() %>%
  group_by(port_code) %>% 
  mutate(port_id = cur_group_id(),
         mean_container = mean(container, na.rm=T)) %>% ungroup()
         
port_group_list <- port_data_agg %>% filter(group!=0) %>% group_by(group) %>%
  summarize(ports = toString(unique(port)))

port_group_list_op <- port_data_agg %>% filter(group_operation!=0) %>% group_by(group_operation) %>%
                                     summarize(ports = toString(unique(port))) %>% 
                                     rename(group = group_operation)
port_group_list <- rbind(port_group_list, port_group_list_op)
port_group_list <- port_group_list[!duplicated(port_group_list$group),]
port_group_list$ports <- paste(port_group_list$ports,paste("(", port_group_list$group, ")", sep = ""))


subsample <- subset(port_data_TEU_in, sender_region == "SE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_south" = "container")

port_data_agg_final <- merge(port_data_agg,subsample, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_south = ifelse(is.na(container_south), 0, container_south)) %>%
  mutate(fraction_south_container = container_south/container)

mean(port_data_agg_final$fraction_south_container, na.rm=T)
max(port_data_agg_final$fraction_south_container, na.rm=T)
min(port_data_agg_final$fraction_south_container, na.rm=T)

subsample2 <- subset(port_data_TEU_in, sender_region == "EX" | sender_region == "NE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_other" = "container") 

port_data_agg_final <- merge(port_data_agg_final,reporter_region, by = "reporter_code") %>%
  relocate(reporter_region, .after = reporter_code) 

port_data_agg_final <- merge(port_data_agg_final,subsample2, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_other = ifelse(is.na(container_other), 0, container_other)) %>%
  mutate(container_total = container_other + container_south)

port_data_agg_final <- mutate(port_data_agg_final, fraction_china_container=origin_china/(container)) 

port_data_agg_final$SE <- ifelse(port_data_agg_final$reporter_region == 'SE', 1, 0)
mean(port_data_agg_final$SE)

subsample3 <- subset(port_data_TEU_in, sender_region == "NE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_north" = "container")

port_data_agg_final <- merge(port_data_agg_final,subsample3, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_north = ifelse(is.na(container_north), 0, container_north)) %>% 
  mutate(fraction_north_container = container_north/container) 

port_data_agg_final <- port_data_agg_final %>%
  mutate(container_south_2=ifelse(container_south == 0, 1, container_south)) %>%
  mutate(container_north_2=ifelse(container_north == 0, 1, container_north)) %>%
  mutate(fraction_south_north = container_south_2/container_north_2)
```

## total container throughput per region_pair
```{r echo=FALSE, warning=FALSE}
port_data_TEU_in %>%
  group_by(region_pair) %>%
  summarise_at(vars(container), list(container_sum = sum), na.rm=T) %>%
  arrange(desc(container_sum))

```

## Mean fractions of partners from total throughput per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_south_container), list(fraction_south_container = mean), na.rm=T)

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_north_container), list(fraction_north_container = mean), na.rm=T)

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_china_container), list(fraction_china_container = mean), na.rm=T)
```


## Development mean south container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

southfraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_southfraction=mean(fraction_south_container, na.rm=T))

ggplot(data=southfraction, aes(x=period, y=average_southfraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of south fraction")
```

## Development mean north container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

northfraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_northfraction=mean(fraction_north_container, na.rm=T))

ggplot(data=northfraction, aes(x=period, y=average_northfraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of north fraction")
```

## Development mean CH container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

chinafraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_chinafraction=mean(fraction_china_container, na.rm=T))

ggplot(data=chinafraction, aes(x=period, y=average_chinafraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of china fraction")
```

## Share of total container throughput over region pairs: TEU 1997-2023
```{r echo=FALSE, warning=FALSE}
throughput_development_regionpair_in <- port_data_TEU_in %>% group_by(region_pair) %>% summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  arrange(desc(throughput)) %>% mutate(fraction = round(throughput/sum(throughput)*100))

ggplot(throughput_development_regionpair_in, aes(x="", y=fraction, fill=region_pair))+
  geom_bar(stat="identity", color="black")+
  coord_polar("y")+
  theme_void()+
  scale_fill_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  geom_label(aes(label=fraction),
             position = position_stack(vjust = 0.5),
             color="black",
             label.size = 0,
             size=6,
             show.legend = FALSE)+
  labs(caption = "In Percent of total container throughput.")
# 51% of total throughput takes place in north ports, 8% between North and South in equal shares with respect to direction, 40% takes place in South ports.
```
The shares among the region_pairs remains similar when we only use inflows as compared to total flows (inflows+outflows).

### Development of total throughputs per region pair over years

```{r echo=FALSE, warning=FALSE, message=FALSE}
throughput_development_regionpair_year_in <- port_data_TEU_in %>% 
  group_by(region_pair, year) %>% 
  summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(year) %>%
  mutate(fraction = (throughput/sum(throughput)*100))

throughput_development_regionpair_yearquater_in <- port_data_TEU_in %>% group_by(region_pair, year, quarter, period) %>% summarise(throughput=sum(container, na.rm=TRUE))  %>% 
  arrange(desc(throughput))

throughput_development_regionpair_yearquater_in$yq <- as.yearqtr(paste0(throughput_development_regionpair_yearquater_in$year, "-", throughput_development_regionpair_yearquater_in$quarter))

ggplot(data=throughput_development_regionpair_year_in, aes(x=year, y=throughput, group=region_pair))+
  geom_line(aes(color=region_pair))+
  scale_color_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  labs(title = "Line chart - yearly data")

# plot for quaters
ggplot(data=throughput_development_regionpair_yearquater_in, aes(x= yq, y=throughput, group=region_pair))+
  geom_line(aes(color=region_pair))+
  scale_color_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  labs(title = "Line chart - quarterly data")

throughput_development_regionpair_year_in$group <- factor(throughput_development_regionpair_year_in$region_pair, levels=c("NEEX_region", "NENE_region", "SEEX_region", "SESE_region", "SENE_region", "NESE_region"))

ggplot(throughput_development_regionpair_year_in, aes(x=year, y=fraction, fill=group)) + 
  geom_area( size=0.5, colour="black")+
  scale_fill_manual(values = c("darkblue", "blue", "orange", "red", "yellow", "green"))+
  labs(title = "Area chart")
  
```

Again very similar results with respect to container throughput development when we consider container inflows only rather than summing up in- and outflows.


# Descriptives for Reshuffling: Outflows (n=319,742)

<!-- Data manipulation work -->

```{r include=FALSE}
port_data_agg <- port_data_TEU_out %>% mutate(origin_china = ifelse(!is.na(container) & (receiver_code=="CN_X_HK" | receiver_code=="HK"),container,0)) %>%
  group_by(port, port_code, period, reporter_code) %>% 
  summarize(container = sum(container, na.rm=T),
            real_gdp_reporter = mean(real_gdp_reporter),
            origin_china = sum(origin_china),
            group = max(group),
            group_operation = max(group_operation),
            ownership_china = max(ownership_china),
            operation = max(operation)) %>% ungroup() %>%
  group_by(port_code) %>% 
  mutate(port_id = cur_group_id(),
         mean_container = mean(container, na.rm=T)) %>% ungroup()
         
port_group_list <- port_data_agg %>% filter(group!=0) %>% group_by(group) %>%
  summarize(ports = toString(unique(port)))

port_group_list_op <- port_data_agg %>% filter(group_operation!=0) %>% group_by(group_operation) %>%
                                     summarize(ports = toString(unique(port))) %>% 
                                     rename(group = group_operation)
port_group_list <- rbind(port_group_list, port_group_list_op)
port_group_list <- port_group_list[!duplicated(port_group_list$group),]
port_group_list$ports <- paste(port_group_list$ports,paste("(", port_group_list$group, ")", sep = ""))


subsample <- subset(port_data_TEU_out, receiver_region == "SE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_south" = "container")

port_data_agg_final <- merge(port_data_agg,subsample, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_south = ifelse(is.na(container_south), 0, container_south)) %>%
  mutate(fraction_south_container = container_south/container)

mean(port_data_agg_final$fraction_south_container, na.rm=T)
max(port_data_agg_final$fraction_south_container, na.rm=T)
min(port_data_agg_final$fraction_south_container, na.rm=T)

subsample2 <- subset(port_data_TEU_out, receiver_region == "EX" | receiver_region == "NE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_other" = "container") 

port_data_agg_final <- merge(port_data_agg_final,reporter_region, by = "reporter_code") %>%
  relocate(reporter_region, .after = reporter_code) 

port_data_agg_final <- merge(port_data_agg_final,subsample2, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_other = ifelse(is.na(container_other), 0, container_other)) %>%
  mutate(container_total = container_other + container_south)

port_data_agg_final <- mutate(port_data_agg_final, fraction_china_container=origin_china/(container)) 

port_data_agg_final$SE <- ifelse(port_data_agg_final$reporter_region == 'SE', 1, 0)
mean(port_data_agg_final$SE)

subsample3 <- subset(port_data_TEU_out, receiver_region == "NE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_north" = "container")

port_data_agg_final <- merge(port_data_agg_final,subsample3, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_north = ifelse(is.na(container_north), 0, container_north)) %>% 
  mutate(fraction_north_container = container_north/container) 

port_data_agg_final <- port_data_agg_final %>%
  mutate(container_south_2=ifelse(container_south == 0, 1, container_south)) %>%
  mutate(container_north_2=ifelse(container_north == 0, 1, container_north)) %>%
  mutate(fraction_south_north = container_south_2/container_north_2)
```

## total container throughput per region_pair
```{r echo=FALSE, warning=FALSE}
port_data_TEU_out %>%
  group_by(region_pair) %>%
  summarise_at(vars(container), list(container_sum = sum), na.rm=T) %>%
  arrange(desc(container_sum))

```

## Mean fractions of partners from total throughput per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_south_container), list(fraction_south_container = mean), na.rm=T)

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_north_container), list(fraction_north_container = mean), na.rm=T)

port_data_agg_final %>%
  group_by(reporter_region) %>%
  summarise_at(vars(fraction_china_container), list(fraction_china_container = mean), na.rm=T)
```


## Development mean south container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

southfraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_southfraction=mean(fraction_south_container, na.rm=T))

ggplot(data=southfraction, aes(x=period, y=average_southfraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of south fraction")
```

## Development mean north container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

northfraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_northfraction=mean(fraction_north_container, na.rm=T))

ggplot(data=northfraction, aes(x=period, y=average_northfraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of north fraction")
```

## Development mean CH container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

chinafraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_chinafraction=mean(fraction_china_container, na.rm=T))

ggplot(data=chinafraction, aes(x=period, y=average_chinafraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of china fraction")
```

There are constant fractions of container throughput by origin over the period with a majority of containers traded within the region. There was a rapid increase of the fraction of Chinese containers in Southern European ports from 2004-2011 until it reached the fraction reached the levels of Northern European ports.´

Compared with inflows data, the fraction of South containers for Northern European countries is higher for Inflows as compared to outflows. The fraction of north containers for Southern European countries is higher for Outflows as compared to inflows.

Suggesting that for Northern European countries, Southern European ports are relatively more important sender as compared to receiver partners, as a fraction from to all senders and receivers Northern European ports are, in contrast, more important receiver partners as sender partners for Southern European ports. There is a higher fraction of trade running from South to North.

## Share of total container throughput over region pairs: TEU 1997-2023
```{r echo=FALSE, warning=FALSE}
throughput_development_regionpair_out <- port_data_TEU_out %>% group_by(region_pair) %>% summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  arrange(desc(throughput)) %>% mutate(fraction = round(throughput/sum(throughput)*100))

ggplot(throughput_development_regionpair_out, aes(x="", y=fraction, fill=region_pair))+
  geom_bar(stat="identity", color="black")+
  coord_polar("y")+
  theme_void()+
  scale_fill_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  geom_label(aes(label=fraction),
             position = position_stack(vjust = 0.5),
             color="black",
             label.size = 0,
             size=6,
             show.legend = FALSE)+
  labs(caption = "In Percent of total container throughput.")
# 51% of total throughput takes place in north ports, 8% between North and South in equal shares with respect to direction, 40% takes place in South ports.
```

The share of Southern European countries on total throughput is slightly higher when we look at outflows rather than inflows.

### Development of total throughputs per region pair over years

```{r echo=FALSE, warning=FALSE, message=FALSE}
throughput_development_regionpair_year_out <- port_data_TEU_out %>% 
  group_by(region_pair, year) %>% 
  summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(year) %>%
  mutate(fraction = (throughput/sum(throughput)*100))

throughput_development_regionpair_yearquater_out <- port_data_TEU_out %>% group_by(region_pair, year, quarter, period) %>% summarise(throughput=sum(container, na.rm=TRUE))  %>% 
  arrange(desc(throughput))

throughput_development_regionpair_yearquater_out$yq <- as.yearqtr(paste0(throughput_development_regionpair_yearquater_out$year, "-", throughput_development_regionpair_yearquater_out$quarter))

ggplot(data=throughput_development_regionpair_year_out, aes(x=year, y=throughput, group=region_pair))+
  geom_line(aes(color=region_pair))+
  scale_color_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  labs(title = "Line chart - yearly data")

# plot for quaters
ggplot(data=throughput_development_regionpair_yearquater_out, aes(x= yq, y=throughput, group=region_pair))+
  geom_line(aes(color=region_pair))+
  scale_color_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  labs(title = "Line chart - quarterly data")

throughput_development_regionpair_year_out$group <- factor(throughput_development_regionpair_year_out$region_pair, levels=c("NEEX_region", "NENE_region", "SEEX_region", "SESE_region", "SENE_region", "NESE_region"))

ggplot(throughput_development_regionpair_year_out, aes(x=year, y=fraction, fill=group)) + 
  geom_area( size=0.5, colour="black")+
  scale_fill_manual(values = c("darkblue", "blue", "orange", "red", "yellow", "green"))+
  labs(title = "Area chart")
  
```

When we compare the results using data on outflows rather than inflows, we see that there is a slightly higher share of Southern European countries with respect to both, outflows to extra-European destinations and outflows to Southern European destinations.

We see a similar trend when we look at outflows compared to inflows. The one difference is that the role of Southern European countries' throughput is more pronounced when we use outflow data as compared to inflow data. The total throughput data statistics show an average of these two. 

Overall, we see that throughput of Southern European ports has increased with all trading partners: Northern European countries, Southern European countries, and extra-European countries. When we look at outflows only, this development can be seen the most obvious.

Looking at outflow data we see kink in the trade of Northern European countries from 2012-2018, but not for Southern European ones. We do not see this with inflow data.

# Descriptives for Reshuffling: Total without ports with Chinese investments (n=266,031)

## Mean container throughput per region_pair
```{r echo=FALSE, warning=FALSE}

ports_treated<- filter(port_data_TEU,         #filter out small ports
                       ownership_china==1) %>%
                      group_by(port_code) %>%
                      filter(row_number()==1) %>%
                      mutate(treated_port=1) %>%
                      select(c("port_code", "treated_port"))

port_data_TEU <- merge(port_data_TEU,ports_treated, by = "port_code", all.x = T) 
port_data_TEU$treated_port[is.na(port_data_TEU$treated_port)] <- 0

port_data_TEU_noCh <- filter(port_data_TEU,         #filter out small ports
                        treated_port!=1,
                        #port!="Algeciras"
                        ) 

throughput_development_regionpair_total_noCh <- port_data_TEU_noCh %>% group_by(region_pair) %>% summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  arrange(desc(throughput)) %>% mutate(fraction = round(throughput/sum(throughput)*100))
```

Mean container throughput without ports with Chinese investments is of a magnitude of 1000 TEU smaller as compared to the full sample. Region_pair ranking in the mean throughput size remains the same.

## Share of total container throughput over region pairs: TEU 1997-2023
```{r echo=FALSE, warning=FALSE}
ggplot(throughput_development_regionpair_total_noCh, aes(x="", y=fraction, fill=region_pair))+
  geom_bar(stat="identity", color="black")+
  coord_polar("y")+
  theme_void()+
  scale_fill_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  geom_label(aes(label=fraction),
             position = position_stack(vjust = 0.5),
             color="black",
             label.size = 0,
             size=6,
             show.legend = FALSE)+
  labs(caption = "In Percent of total container throughput.")
# 51% of total throughput takes place in north ports, 8% between North and South in equal shares with respect to direction, 40% takes place in South ports.
```

The fraction of containers handled in Southern European ports increases as we exclude ports with Chinese investments. This is due to the omission of Rotterdam and Antwerp, the largest (Northern) European ports.

### Development of total throughputs per region pair over years

```{r echo=FALSE, warning=FALSE, message=FALSE}
throughput_development_regionpair_year_noCh <- port_data_TEU_noCh %>% 
  group_by(region_pair, year) %>% 
  summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(year) %>%
  mutate(fraction = (throughput/sum(throughput)*100))

throughput_development_regionpair_yearquater_noCh <- port_data_TEU_noCh %>% group_by(region_pair, year, quarter, period) %>% summarise(throughput=sum(container, na.rm=TRUE))  %>% 
  arrange(desc(throughput))

throughput_development_regionpair_yearquater_noCh$yq <- as.yearqtr(paste0(throughput_development_regionpair_yearquater_noCh$year, "-", throughput_development_regionpair_yearquater_noCh$quarter))

ggplot(data=throughput_development_regionpair_year_noCh, aes(x=year, y=throughput, group=region_pair))+
  geom_line(aes(color=region_pair))+
  scale_color_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  labs(title = "Line chart - yearly data")

```

If we take the 18 China-treated ports out of the sample, we take out th biggest ports (Rotterdam, Antwerp, Piraeus). We then see a parallel growth trend of Southern and Northern European ports until the global financial crisis that coincides with China's investment in Piraeus. In the aftermaths, we see a strong growth of Southern European untreated ports in their intra-, inter-, and extra-regional trade. 

# To discuss for the graphs
(1) Should we show two pie charts with the region shares for the two time spans? A comparison of the years 2000-2010 with the years 2010-2020 shares. Or a comparison of shars before the financial crisis in 2009 to afterwards?
(2) Should we truncate the graphs to 2000-2020 to get rid of the ugly ends that are burdened with missing reports of Southern European countries before 2000 and the covid-pandemic after 2020?


# Development of total container by region

```{r echo=FALSE, warning=FALSE, message=FALSE}

total <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(containerN=sum(container_north, na.rm=T))


total2 <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(containerS=sum(container_south, na.rm=T))

ggplot(data=total, aes(x=period, y=containerN, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of North containers")

ggplot(data=total2, aes(x=period, y=containerS, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of South containers")
```

# Development of total container from Greece, US, China by region

```{r echo=FALSE, warning=FALSE, message=FALSE}

partner_Greece <- filter(port_data_TEU,      
                        partner_code=="EL")

total <- partner_Greece %>% 
  group_by(reporter_region, year) %>% summarise(containerEL=sum(container, na.rm=T))

ggplot(data=total, aes(x=year, y=containerEL, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with Greece")

partner_Spain <- filter(port_data_TEU,      
                        partner_code=="ES")

total0 <- partner_Spain %>% 
  group_by(reporter_region, year) %>% summarise(containerES=sum(container, na.rm=T))

ggplot(data=total0, aes(x=year, y=containerES, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with Spain")


partner_Italy <- filter(port_data_TEU,      
                        partner_code=="IT")

total4 <- partner_Italy %>% 
  group_by(reporter_region, year) %>% summarise(containerIT=sum(container, na.rm=T))

ggplot(data=total4, aes(x=year, y=containerIT, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with Italy")

partner_China <- filter(port_data_TEU,      
                        partner_code=="CN_X_HK" | partner_code=="HK")

total2 <- partner_China %>% 
  group_by(reporter_region, year) %>% summarise(containerCH=sum(container, na.rm=T))

ggplot(data=total2, aes(x=year, y=containerCH, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with China")

partner_US <- filter(port_data_TEU,      
                        partner_code=="US")

total3 <- partner_US %>% 
  group_by(reporter_region, year) %>% summarise(containerUS=sum(container, na.rm=T))

ggplot(data=total3, aes(x=year, y=containerUS, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with US")
```
