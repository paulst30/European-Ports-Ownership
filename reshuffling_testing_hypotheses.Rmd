---
title: "Reshuffling_testing_hypotheses"
author: "Katja Kalkschmied"
date: "2024-02-27"
output: html_document
---

```{r include=FALSE}
library(dplyr)
library(writexl)
library(readxl)
library(ggplot2)
library(echoice2)
library(doBy)
library(zoo)
library(fixest)
library(did)
library(gt)


load("port_data_TEU.RData")

port_data_TEU <- filter(port_data_TEU, aggregate==0,
                        stat_port==1,              #filter out non-stat ports (and geographic aggregates)
                        TEU_yrly >=20000,          #filter out small ports
                        port_code!="DEHAM") %>%    #exclude Hamburg due to very recent treatment
  mutate(s_china = ifelse(sender_code=="CN_X_HK" | sender_code=="HK", 1, 0)) %>%
  group_by(port_code, sender_code) %>%
  mutate(pair_id=cur_group_id()) %>% ungroup() %>%
  rename(container=total_TEU) %>%
  rename(partner_code=sender_code) %>%
  rename(partner=sender)

summary(port_data_TEU$container, na.rm=TRUE)


listpartner <- port_data_TEU %>%
  group_by(partner_code) %>%
  slice(1) %>%
  ungroup() %>%
  select(partner_code, partner)


listreporter <- port_data_TEU %>%
  group_by(reporter_code) %>%
  slice(1) %>%
  ungroup() %>%
  select(reporter_code, reporter)

write_xlsx(listpartner, "listpartner.xlsx")

partner_region <- read_xlsx("partner_region.xlsx", sheet = "Sheet1")

reporter_region <- merge(listreporter, partner_region, by.x = "reporter_code", by.y = "partner_code", all.x = T) %>% 
  select(reporter_code, partner_region) %>% 
  rename("reporter_region" = "partner_region")

port_data_TEU <- merge(port_data_TEU,partner_region, by = "partner_code") %>%
  relocate(partner_region, .after = partner_code)

port_data_TEU <- merge(port_data_TEU,reporter_region, by = "reporter_code") %>%
  relocate(reporter_region, .after = reporter_code) 

port_data_TEU$NENE_region <- ifelse(port_data_TEU$reporter_region == 'NE' & port_data_TEU$partner_region == 'NE', 1, 0)
sum(port_data_TEU$NENE_region)

port_data_TEU$SESE_region <- ifelse(port_data_TEU$reporter_region == 'SE' & port_data_TEU$partner_region == 'SE', 1, 0)
sum(port_data_TEU$SESE_region)

port_data_TEU$NESE_region <- ifelse(port_data_TEU$reporter_region == 'NE' & port_data_TEU$partner_region == 'SE', 1, 0)
sum(port_data_TEU$NESE_region)

port_data_TEU$SENE_region <- ifelse(port_data_TEU$reporter_region == 'SE' & port_data_TEU$partner_region == 'NE', 1, 0)
sum(port_data_TEU$SENE_region)

port_data_TEU$NEEX_region <- ifelse(port_data_TEU$reporter_region == 'NE' & port_data_TEU$partner_region == 'EX', 1, 0)
sum(port_data_TEU$NEEX_region)

port_data_TEU$SEEX_region <- ifelse(port_data_TEU$reporter_region == 'SE' & port_data_TEU$partner_region == 'EX', 1, 0)
sum(port_data_TEU$SEEX_region)

region_pair <- ec_undummy(port_data_TEU, c('NENE_region', 'SESE_region', 'NESE_region', 'SENE_region','NEEX_region','SEEX_region'), "region_pair", ref_level = "What") %>%
  select(port_code, partner_code, region_pair, year, quarter) 

port_data_TEU <- merge(port_data_TEU,region_pair, by.x=c("port_code", "partner_code", "year", "quarter"), by.y=c("port_code", "partner_code", "year", "quarter"))

port_data_agg <- port_data_TEU %>% mutate(origin_china = ifelse(!is.na(container) & (partner_code=="CN_X_HK" | partner_code=="HK"),container,0)) %>%
  group_by(port, port_code, period, reporter_code) %>% 
  summarize(container = sum(container, na.rm=T),
            real_gdp_reporter = mean(real_gdp_reporter),
            origin_china = sum(origin_china),
            group = max(group),
            group_operation = max(group_operation),
            ownership_china = max(ownership_china),
            operation = max(operation)) %>% ungroup() %>%
  group_by(port_code) %>% 
  mutate(port_id = cur_group_id(),
         mean_container = mean(container, na.rm=T)) %>% ungroup()
         
port_group_list <- port_data_agg %>% filter(group!=0) %>% group_by(group) %>%
  summarize(ports = toString(unique(port)))

port_group_list_op <- port_data_agg %>% filter(group_operation!=0) %>% group_by(group_operation) %>%
                                     summarize(ports = toString(unique(port))) %>% 
                                     rename(group = group_operation)
port_group_list <- rbind(port_group_list, port_group_list_op)
port_group_list <- port_group_list[!duplicated(port_group_list$group),]
port_group_list$ports <- paste(port_group_list$ports,paste("(", port_group_list$group, ")", sep = ""))


subsample <- subset(port_data_TEU, partner_region == "SE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_south" = "container")

port_data_agg_final <- merge(port_data_agg,subsample, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_south = ifelse(is.na(container_south), 0, container_south)) %>%
  mutate(fraction_south_container = container_south/container)

mean(port_data_agg_final$fraction_south_container, na.rm=T)
max(port_data_agg_final$fraction_south_container, na.rm=T)
min(port_data_agg_final$fraction_south_container, na.rm=T)

subsample2 <- subset(port_data_TEU, partner_region == "EX" | partner_region == "NE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_other" = "container") 

port_data_agg_final <- merge(port_data_agg_final,reporter_region, by = "reporter_code") %>%
  relocate(reporter_region, .after = reporter_code) 

port_data_agg_final <- merge(port_data_agg_final,subsample2, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_other = ifelse(is.na(container_other), 0, container_other)) %>%
  mutate(container_total = container_other + container_south)

port_data_agg_final <- mutate(port_data_agg_final, fraction_china_container=origin_china/(container)) 

port_data_agg_final$SE <- ifelse(port_data_agg_final$reporter_region == 'SE', 1, 0)
mean(port_data_agg_final$SE)

subsample3 <- subset(port_data_TEU, partner_region == "NE") %>%
  group_by(port_code, period) %>% 
  summarize(container = sum(container, na.rm=T)) %>% 
  rename("container_north" = "container")

port_data_agg_final <- merge(port_data_agg_final,subsample3, by = c("port_code", "period"), all.x=T) %>%
  mutate(container_north = ifelse(is.na(container_north), 0, container_north)) %>% 
  mutate(fraction_north_container = container_north/container) 

port_data_agg_final <- port_data_agg_final %>%
  mutate(container_south_2=ifelse(container_south == 0, 1, container_south)) %>%
  mutate(container_north_2=ifelse(container_north == 0, 1, container_north)) %>%
  mutate(fraction_south_north = container_south_2/container_north_2)
```

# Development of total throughput per region pair over years

```{r echo=FALSE, warning=FALSE, message=FALSE}
throughput_development_regionpair_year <- port_data_TEU %>% 
  group_by(region_pair, year) %>% 
  summarise(throughput=sum(container, na.rm=TRUE)) %>% 
  ungroup() %>%
  group_by(year) %>%
  mutate(fraction = (throughput/sum(throughput)*100))

ggplot(data=throughput_development_regionpair_year, aes(x=year, y=throughput, group=region_pair))+
  geom_line(aes(color=region_pair))+
  scale_color_manual(values = c("darkblue", "blue", "green", "orange", "yellow", "red"))+
  labs(title = "Line chart - yearly data")

throughput_development_regionpair_year$group <- factor(throughput_development_regionpair_year$region_pair, levels=c("NEEX_region", "NENE_region", "SEEX_region", "SESE_region", "SENE_region", "NESE_region"))

ggplot(throughput_development_regionpair_year, aes(x=year, y=fraction, fill=group)) + 
  geom_area( size=0.5, colour="black")+
  scale_fill_manual(values = c("darkblue", "blue", "orange", "red", "yellow", "green"))+
  labs(title = "Area chart")
  
```


Looking at the development of total container throughput (container inflows plus outflows) of port pairs aggregated to the regional level, we find that after 2009 there was a rapid increase in trade among Southern European ports and with Southern European ports and extra-European countries. The share of containers handled by Southern European ports from all containers handled in our European port sample decreased from 2000-2009 and increased from 2009 on.

***I would include the line graph in the paper***

***Shall we truncate the graph from 2000-2020? Should we truncate the whoe dataset form 2000_Q1-2020_01?***


# Overview Hypotheses

We test 3 hypotheses which can explain the increase in European South-South and South-External maritime trade and the increase in the trade share of Southern European ports after 2009:

1)	Southern European ports with Chinese investment (Greece, Spain, Italy, Turkey, Bulgaria) were functioning as multipliers and encouraged South-South and South-External trade.

2)	The deepening of the Suez Canal allowed to increase volume and decrease transportation time of maritime trade between Europe and Southeast Asia as well as Eastern Africa after its reopening in 2009.

3)	The global financial crisis 2007-08 weakened North-North trade, especially exchange with the US which came in via Northern European ports. China was hit less by the crisis and could offer competitive prices such that there was a diversion of trade from the EU and US to EU and China with a different trading route that enters European markets via the Mediterranean Sea.

# Testing Hypothesis 1

## Investigating inter- versus intraregional trade

### Development of port's mean south container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

southfraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_southfraction=mean(fraction_south_container, na.rm=T))

ggplot(data=southfraction, aes(x=period, y=average_southfraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of south fraction")
```

### Development of port's mean north container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

northfraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_northfraction=mean(fraction_north_container, na.rm=T))

ggplot(data=northfraction, aes(x=period, y=average_northfraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of north fraction")
```

### Development of port's mean CH container fraction per region

```{r echo=FALSE, warning=FALSE, message=FALSE}

chinafraction <- port_data_agg_final %>% 
  group_by(reporter_region, period) %>% summarise(average_chinafraction=mean(fraction_china_container, na.rm=T))

ggplot(data=chinafraction, aes(x=period, y=average_chinafraction, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of china fraction")
```


The fraction of trade within the region was high and betweeen the regions was low throughout the period. This underlines the importance of intraregional trade

Whereas the fraction of Southern European trade within Southern European countries decreased slightly until 2009, it increased afterwards. 

Southern European ports experienced an increase in the fraction of trade with China in the period 30-60, that is from 2004-2012. Afterwards, it reached a similar level as for Northern European ports.



### South and North trade of treated Southern European countries

```{r echo=FALSE, warning=FALSE, message=FALSE}

partner_Greece <- filter(port_data_TEU,      
                        partner_code=="EL")

total <- partner_Greece %>% 
  group_by(reporter_region, year) %>% summarise(containerEL=sum(container, na.rm=T))

ggplot(data=total, aes(x=year, y=containerEL, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with Greece")

partner_Spain <- filter(port_data_TEU,      
                        partner_code=="ES")

total1 <- partner_Spain %>% 
  group_by(reporter_region, year) %>% summarise(containerES=sum(container, na.rm=T))

ggplot(data=total1, aes(x=year, y=containerES, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with Spain")


partner_Italy <- filter(port_data_TEU,      
                        partner_code=="IT")

total2 <- partner_Italy %>% 
  group_by(reporter_region, year) %>% summarise(containerIT=sum(container, na.rm=T))

ggplot(data=total2, aes(x=year, y=containerIT, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with Italy")

partner_Turkey <- filter(port_data_TEU,      
                        partner_code=="TR")

total3 <- partner_Turkey %>% 
  group_by(reporter_region, year) %>% summarise(containerTR=sum(container, na.rm=T))

ggplot(data=total3, aes(x=year, y=containerTR, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with Turkey")
```
Trade increases were predominately with other Southern European countries. We can eyespot the increase after 2009 and also increases after the respective treatments:

Greece: 2009
Italy: 2017
Spain: 2012
Turkey: 2015


### Development of total container for SESE and SEEX region pairs by country

```{r echo=FALSE, warning=FALSE, message=FALSE}

South_sample <- filter(port_data_TEU,      
                        region_pair=="SESE_region")

total13 <- South_sample %>% 
  group_by(partner, year) %>% summarise(container=sum(container, na.rm=T))

total13$partner <- factor(total13$partner, levels=c("Spain", "Italy", "Turkey", "Greece", "Portugal", "Malta", "Romania", "Slovenia", "Cyprus", "Bulgaria", "Croatia", "Montenegro"))

ggplot(total13, aes(x=year, y=container, fill=partner))+
  geom_area()+
  scale_fill_manual(values = c("blue", "red", "pink", "orange", "yellow", "lightyellow", "black", "black", "black", "black","black", "black"))+
  labs(title = "Area chart - Breakdown of SESE trade by country")


SouthEX_sample <- filter(port_data_TEU,      
                        region_pair=="SEEX_region")

total14 <- SouthEX_sample %>% 
  group_by(reporter, year) %>% summarise(container=sum(container, na.rm=T))

total14$reporter <- factor(total14$reporter, levels=c("Turkey", "Spain", "Italy", "Greece", "Portugal", "Malta", "Romania", "Slovenia", "Cyprus", "Bulgaria", "Croatia", "Montenegro"))

ggplot(total14, aes(x=year, y=container, fill=reporter))+
  geom_area()+
  scale_fill_manual(values = c("pink", "blue", "red", "orange", "yellow", "black", "black", "black", "black", "black","black", "black"))+
  labs(title = "Area chart - Breakdown of SEEX trade by country")



```

Of relevance for South South Trade are the countries: Italy, Spain, Turkey, Greece, Portugal, and Malta. The four most important are China treated. 

Ambarli only reports after 2010. That is why we have a kink in the graph. This kink does not show up in the SESE graph because there reports from other European ports with Turkish ports including Ambarli show up. 

### Importance of treated ports for SESE and SEEX trade

```{r echo=FALSE, warning=FALSE, message=FALSE}

South_s_sample <- filter(port_data_TEU,      
                        region_pair=="SESE_region", port=="Piraeus" | port=="Barcelona"| port=="Valencia"| port=="Genova"| port=="Ambarli" | port=="Bilbao")

total16 <- South_s_sample %>%
  group_by(port, year) %>% summarise(container=sum(container, na.rm=T))

total16$port <- factor(total16$port, levels=c( "Ambarli", "Valencia", "Bilbao", "Barcelona", "Genova", "Piraeus"))

ggplot(total16, aes(x=year, y=container, fill=port))+
  geom_area()+
  scale_fill_manual(values = c("pink", "darkblue", "blue", "lightblue", "red", "orange"))+
  labs(title = "Area chart - Contribution of China-treated ports to SESE trade")


South_x_sample <- filter(port_data_TEU,      
                        region_pair=="SEEX_region", port=="Piraeus" | port=="Barcelona"| port=="Valencia"| port=="Genova"| port=="Ambarli" | port=="Bilbao")

total17 <- South_x_sample %>%
  group_by(port, year) %>% summarise(container=sum(container, na.rm=T))

total17$port <- factor(total17$port, levels=c("Ambarli", "Valencia", "Bilbao", "Barcelona", "Genova", "Piraeus"))

ggplot(total17, aes(x=year, y=container, fill=port))+
  geom_area()+
  scale_fill_manual(values = c("pink", "darkblue", "blue", "lightblue", "red", "orange"))+
  labs(title = "Area chart - Contribution of China-treated ports to SEEX trade")

```

```{r include=FALSE}

sum(South_sample$container, na.rm=T)
sum(SouthEX_sample$container, na.rm=T)


Chports_SESE <- South_s_sample %>%
  group_by(port) %>% summarise(container=sum(container, na.rm=T)) %>% 
  mutate(total=302945425, share=container*100/total) %>% 
  arrange(desc(share))

sum(Chports_SESE$share, na.rm=T)
```

The SESE and SEEX graps start from 2000 suggesting that the Southern European countries started reporting only with 2000. That would support truncating the period of analysis to 2000.

Piraeus and Valencia can be eyespotted as most important. 

For SESE trade, Chinese treated ports accounted for a share of together 28%. The ranking with respect to the share of the individual ports of is: Piraeus, Valencia, Genova, Ambarli, Barcelona, Bilbao.

For SEEX trade, Chinese treated ports accounted for a share of together 43%. The ranking with respect to the share of the individual ports is: Valencia, Barcelona, Piraeus, Ambarli, Genova, Bilbao. 

### Investigating SEEX trade: Development of external trade of the treated ports 
```{r include=FALSE}

sum(SouthEX_sample$container, na.rm=T)


Chports_SEEX <- South_x_sample %>%
  group_by(port) %>% summarise(container=sum(container, na.rm=T)) %>% 
  mutate(total=412874752, share=container*100/total) %>% 
  arrange(desc(share))

sum(Chports_SEEX$share, na.rm=T)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Valencia

partners_Valencia <- South_x_sample %>%
  filter(port=="Valencia") %>%
  group_by(partner) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

partners_Valencia_year <- South_x_sample %>%
  filter(port=="Valencia", partner=="China (except Hong Kong)" | partner=="United States" | partner=="Algeria" | partner=="Brazil" | partner=="Marocco" | partner=="Saudi Arabia" | partner=="Canada" | partner=="India" | partner=="Singapore" | partner=="United Arab Emirates") %>%
  group_by(partner, year) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

ggplot(data=partners_Valencia_year, aes(x=year, y=container, group=partner))+
  geom_line(aes(color=partner))+
  labs(title = "Line chart - development of external trade with Valencia by partner country")
  
# Barcelona
  
partners_Barcelona <- South_x_sample %>%
  filter(port=="Barcelona") %>%
  group_by(partner) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

partners_Barcelona_year <- South_x_sample %>%
  filter(port=="Barcelona", partner=="China (except Hong Kong)" | partner=="United States" | partner=="Algeria" | partner=="Brazil" | partner=="Marocco" | partner=="Saudi Arabia" | partner=="Mexico" | partner=="India" | partner=="Singapore" | partner=="United Arab Emirates") %>%
  group_by(partner, year) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

ggplot(data=partners_Barcelona_year, aes(x=year, y=container, group=partner))+
  geom_line(aes(color=partner))+
  labs(title = "Line chart - development of external trade with Barcelona by partner country")
  
  # Piraeus
  
partners_Piraeus <- South_x_sample %>%
  filter(port=="Piraeus") %>%
  group_by(partner) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

partners_Piraeus_year <- South_x_sample %>%
  filter(port=="Piraeus", partner=="China (except Hong Kong)" | partner=="United States" | partner=="Hong Kong" | partner=="Israel" | partner=="Egypt" | partner=="Saudi Arabia" | partner=="Georgia" | partner=="Ukraine" | partner=="Singapore" | partner=="United Arab Emirates") %>%
  group_by(partner, year) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

ggplot(data=partners_Piraeus_year, aes(x=year, y=container, group=partner))+
  geom_line(aes(color=partner))+
  labs(title = "Line chart - development of external trade with Piraeus by partner country")

# Ambarli
  
partners_Ambarli <- South_x_sample %>%
  filter(port=="Ambarli") %>%
  group_by(partner) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

partners_Ambarli_year <- South_x_sample %>%
  filter(port=="Ambarli", partner=="China (except Hong Kong)" | partner=="Russia" | partner=="Libya" | partner=="Israel" | partner=="Egypt" | partner=="Saudi Arabia" | partner=="Georgia" | partner=="Ukraine" | partner=="Singapore" | partner=="South Korea") %>%
  group_by(partner, year) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

ggplot(data=partners_Ambarli_year, aes(x=year, y=container, group=partner))+
  geom_line(aes(color=partner))+
  labs(title = "Line chart - development of external trade with Ambarli by partner country")
  
# Ambarli
  
partners_Ambarli <- South_x_sample %>%
  filter(port=="Ambarli") %>%
  group_by(partner) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

partners_Ambarli_year <- South_x_sample %>%
  filter(port=="Ambarli", partner=="China (except Hong Kong)" | partner=="Russia" | partner=="Libya" | partner=="Israel" | partner=="Egypt" | partner=="Saudi Arabia" | partner=="Georgia" | partner=="Ukraine" | partner=="Singapore" | partner=="South Korea") %>%
  group_by(partner, year) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

ggplot(data=partners_Ambarli_year, aes(x=year, y=container, group=partner))+
  geom_line(aes(color=partner))+
  labs(title = "Line chart - development of external trade with Ambarli by partner country")
  
# Genova
  
partners_Genova <- South_x_sample %>%
  filter(port=="Genova") %>%
  group_by(partner) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

partners_Genova_year <- South_x_sample %>%
  filter(port=="Genova", partner=="China (except Hong Kong)" | partner=="United States" | partner=="Hong Kong" | partner=="Israel" | partner=="Egypt" | partner=="Saudi Arabia" | partner=="Brazil" | partner=="India" | partner=="Singapore" | partner=="United Arab Emirates") %>%
  group_by(partner, year) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

ggplot(data=partners_Genova_year, aes(x=year, y=container, group=partner))+
  geom_line(aes(color=partner))+
  labs(title = "Line chart - development of external trade with Genova by partner country")  
  
# Bilbao
  
partners_Bilbao <- South_x_sample %>%
  filter(port=="Bilbao") %>%
  group_by(partner) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

partners_Bilbao_year <- South_x_sample %>%
  filter(port=="Bilbao", partner=="China (except Hong Kong)" | partner=="United States" | partner=="Chile" | partner=="Mexico" | partner=="Cuba" | partner=="Brazil" | partner=="Peru" | partner=="Morocco" | partner=="Argentina" | partner=="India") %>%
  group_by(partner, year) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

ggplot(data=partners_Bilbao_year, aes(x=year, y=container, group=partner))+
  geom_line(aes(color=partner))+
  labs(title = "Line chart - development of external trade with Bilbao by partner country")  
  
Bilbao_puzzle <- port_data_TEU  %>%
  filter(port=="Bilbao") %>%
  group_by(region_pair, period) %>% 
  summarise(container=sum(container, na.rm=T)) %>% 
  arrange(desc(container))

ggplot(data=Bilbao_puzzle, aes(x=period, y=container, group=region_pair))+
  geom_line(aes(color=region_pair))+
  labs(title = "Line chart - development of trade of Bilbao by region pair")  
  
  
```

There was an increase in throughput with China for most of the treated ports after Chinese investment. For the single ports the most important external trade partners 1997-2003 were: 

Valencia: 1. China, 2. United States, 3. Algeria, 4. Brazil, 5. Marocco, 6. Saudi Arabia, 7. Canada, 8. India, 9. Singapore, 10. UAE.
There was an increase in throughput from China until 2009 then there was a drop until 2015.

Barcelona: 1. China, 2. Algeria, 3. United States, 4. Morocco, 5. Brazil, 6. India, 7. United Arab Emirates, 8. Saudi Arabia, 9. Singapore, 10. Mexico. There was an increase in throughput from China after Chinese investments.

Piraeus: 1. China, 2. Singapore, 3. Israel, 4. Egypt, 5. Saudi Arabia, 6. United Arab Emirates, 7. Georgia, 8. United States, 9. Ukraine, 10. Hong Kong.  There was an increase in throughput from China after Chinese investments.

Ambarli: 1. China, 2. Egypt, 3. Russia, 4. Georgia, 5. Israel, 6. Ukraine, 7. Singapore, 8. South Korea, 9. Saudi Arabia, 10. Libya. There was a drop in throughput after 2014 for all partner countries.

Genova: 1. China, 2. United States, 3. Egypt, 4. Singapore, 5. Hong Kong, 6. Brazil, 7. India, 8. Israel, 9. United Arab Emirates, 10. Saudi Arabia. There was an increase in throughput from China after Chinese investments.

Bilbao: 1. China, 2. United States, 3. Chile, 4. Mexico, 5. Cuba, 6. Brazil, 7. Peru, 8. Morocco, 9. Arbentina, 10. India. Extraregional trade of Balbao collapsed in 2014 and was replaced by intraregional trade and interregional trade. 

China is number one for all treated ports. The United States matter for ports at or closer to the Atlantic in Spain and Italy (Valencia, Bilbao, Barcelona, Genova)


## Estimations of China treatment effect for SESE throughput development.

### FE estimations SESE (only Southern European partners)

```{r echo=FALSE, warning=FALSE, message=FALSE}

port_data_TEU_SESE <- port_data_TEU %>% 
  filter(region_pair=="SESE_region") %>%
  mutate(Piraeus_treatment = ifelse(partner=="Greece" & period>=52, 1, 0)) %>%
  mutate(all_treatment = ifelse(partner=="Greece" & period>=52, 1, 0))

port_data_TEU_SESE$all_treatment[port_data_TEU_SESE$partner=="Spain" & port_data_TEU_SESE$period>=63] <- 1

port_data_TEU_SESE$all_treatment[port_data_TEU_SESE$partner=="Turkey" & port_data_TEU_SESE$period>=76] <- 1

port_data_TEU_SESE$all_treatment[port_data_TEU_SESE$partner=="Italy" & port_data_TEU_SESE$period>=81] <- 1


sum(port_data_TEU_SESE$Piraeus_treatment) # 7% of observations treated 

sum(port_data_TEU_SESE$all_treatment) # 22% of observations treated

# Greece only
spec1 <- feols(container ~ Piraeus_treatment | port^partner + period,
               data = port_data_TEU_SESE)

spec2 <- feols(container ~ Piraeus_treatment | port^partner + period + partner,
               data = port_data_TEU_SESE)

spec3 <- feols(container ~ Piraeus_treatment | port + period + partner,
               data = port_data_TEU_SESE)

spec4 <- feols(container ~ Piraeus_treatment | port^partner,
               data = port_data_TEU_SESE)



fe_results<- etable(spec1, spec2, spec3, spec4,
                    headers = c("Eq. 1", "Eq. 2", "Eq. 3", "Eq. 4"),
                    style.df = style.df(fixef.title = "Fixed Effects",
                                        fixef.suffix = "", yesNo = "yes"),
                    vcov = "twoway")

fe_results

# all treated 
spec11 <- feols(container ~ all_treatment | port^partner + period,
               data = port_data_TEU_SESE)

spec12 <- feols(container ~ all_treatment | port^partner + period + partner,
               data = port_data_TEU_SESE)

spec13 <- feols(container ~ all_treatment | port + period + partner,
               data = port_data_TEU_SESE)

spec14 <- feols(container ~ all_treatment | port^partner,
               data = port_data_TEU_SESE)

fe2_results<- etable(spec11, spec12, spec13, spec14,
                    headers = c("Eq. 1", "Eq. 2", "Eq. 3", "Eq. 4"),
                    style.df = style.df(fixef.title = "Fixed Effects",
                                        fixef.suffix = "", yesNo = "yes"),
                    vcov = "twoway")

fe2_results
```

The FE estimation suggests a positive multiplier effect of China-treated ports for South-South trade. partner*period fixed effects gehen nicht wegen multicollinearity mit treatment variable.

### FE estimations SE (all partners)

```{r echo=FALSE, warning=FALSE, message=FALSE}

port_data_TEU_SE <- port_data_TEU %>% 
  filter(reporter_region=="SE") %>%
  mutate(Piraeus_treatment = ifelse(partner=="Greece" & period>=52, 1, 0)) %>%
  mutate(all_treatment = ifelse(partner=="Greece" & period>=52, 1, 0))

port_data_TEU_SE$all_treatment[port_data_TEU_SE$partner=="Spain" & port_data_TEU_SE$period>=63] <- 1

port_data_TEU_SE$all_treatment[port_data_TEU_SE$partner=="Turkey" & port_data_TEU_SE$period>=76] <- 1

port_data_TEU_SE$all_treatment[port_data_TEU_SE$partner=="Italy" & port_data_TEU_SE$period>=81] <- 1


sum(port_data_TEU_SE$Piraeus_treatment) # 1,07% of observations treated 

sum(port_data_TEU_SE$all_treatment) # 3,2% of observations treated

# Greece only
spec1 <- feols(container ~ Piraeus_treatment | port^partner + period,
               data = port_data_TEU_SE)

spec2 <- feols(container ~ Piraeus_treatment | port^partner + period + partner,
               data = port_data_TEU_SE)

spec3 <- feols(container ~ Piraeus_treatment | port + period + partner,
               data = port_data_TEU_SE)

spec4 <- feols(container ~ Piraeus_treatment | port^partner,
               data = port_data_TEU_SE)



fe_results<- etable(spec1, spec2, spec3, spec4,
                    headers = c("Eq. 1", "Eq. 2", "Eq. 3", "Eq. 4"),
                    style.df = style.df(fixef.title = "Fixed Effects",
                                        fixef.suffix = "", yesNo = "yes"),
                    vcov = "twoway")

fe_results

# all treated 
spec11 <- feols(container ~ all_treatment | port^partner + period,
               data = port_data_TEU_SE)

spec12 <- feols(container ~ all_treatment | port^partner + period + partner,
               data = port_data_TEU_SE)

spec13 <- feols(container ~ all_treatment | port + period + partner,
               data = port_data_TEU_SE)

spec14 <- feols(container ~ all_treatment | port^partner,
               data = port_data_TEU_SE)


fe2_results<- etable(spec11, spec12, spec13, spec14,
                    headers = c("Eq. 1", "Eq. 2", "Eq. 3", "Eq. 4"),
                    style.df = style.df(fixef.title = "Fixed Effects",
                                        fixef.suffix = "", yesNo = "yes"),
                    vcov = "twoway")

fe2_results
```
The effect remains when we enlarge the sample to include all partner countries. For eq 4 the results are almost identical.

***What is the most suitable FE package?***

***What is the right sample?: The reporting ports are SE. But what are the right partners? Only SE country partners (results 1) or all SE, NE, EX partners (results 2)?***

***Why are the coefficient estimates for eq 4 almost identical for the different samples? Does the FE estimator only use within-variation?***

### Diff-in-Diff estimations

```{r include=FALSE}
attgt_share <- att_gt(yname = "container",            #outcome variable
                      tname = "period",                 #time variable
                      idname = "port_id",                    #id for units (should be port_code*partner)
                      gname = "group",                    #grouping variable for first treatment. Is zero for never treated units
                      #xformla = ~X,                  #for potential covariates
                      #control_group="notyettreated",  #use not yet treated units as control group in addition to never treated units
                      allow_unbalanced_panel = TRUE,  #allows he use of unbalanced panel data. Increases computation time.
                      #est_method = "reg",             #indicates which estimation method should be used ("ipw", inverse probability weighting or "reg" for regression)
                      data = port_data_agg_final)

# attgt_share_cond <- att_gt(yname = "share_china",            #outcome variable
#                 tname = "period",                 #time variable
#                 idname = "port_id",                    #id for units (should be port_code*partner)
#                 gname = "group",                    #grouping variable for first treatment. Is zero for never treated units
#                 xformla = ~mean_container+real_gdp_reporter,                  #for potential covariates
#                 #control_group="notyettreated",  #use not yet treated units as control group in addition to never treated units
#                 allow_unbalanced_panel = TRUE,  #allows he use of unbalanced panel data. Increases computation time.
#                 est_method = "reg",             #indicates which estimation method should be used ("ipw", inverse probability weighting or "reg" for regression)
#                 data = port_data_agg)


# option 1: simple weighted average treatment effect with weights proportional to the group size
agg_simple_share <- aggte(attgt_share, type = "simple", na.rm=T)
#agg_simple_share_cond <- aggte(attgt_share_cond, type = "simple", na.rm=T)

# option 2: event-study type aggregation by time under treatment
agg_es_share <- aggte(attgt_share, type = "dynamic", na.rm=T)
#agg_es_share_cond <- aggte(attgt_share_cond, type = "dynamic", na.rm=T)

# option 3: groupwise treatment effects
agg_gs_share <- aggte(attgt_share, type = "group", na.rm=T)
#agg_gs_share_cond <- aggte(attgt_share_cond, type = "group", na.rm=T)


#port_group_list$ports[match(as.character(agg_gs_op_share$egt), port_group_list$group)]
# putting together the results
share_results1 <- data.frame(Estimate = c("simple average", port_group_list$ports[match(as.character(agg_gs_share$egt), port_group_list$group)]),
                             ATT = c(agg_simple_share$overall.att,
                                     agg_gs_share$att.egt),
                             lower = c(agg_simple_share$overall.att-(agg_simple_share$overall.se*1.95), agg_gs_share$att.egt-(agg_gs_share$se.egt*agg_gs_share$crit.val.egt)),
                             upper = c(agg_simple_share$overall.att+(agg_simple_share$overall.se*1.95), agg_gs_share$att.egt+(agg_gs_share$se.egt*agg_gs_share$crit.val.egt)))

# share_results2 <- data.frame(Estimate = c("simple average", port_group_list$ports[match(as.character(agg_gs_op_share$egt), port_group_list$group)]),
#                        ATT = c(agg_simple_op_share$overall.att,
#                                    agg_gs_op_share$att.egt),
#                       lower = c(agg_simple_op_share$overall.att-(agg_simple_op_share$overall.se*1.95), agg_gs_op_share$att.egt-(agg_gs_op_share$se.egt*agg_gs_op_share$crit.val.egt)),
#                       upper = c(agg_simple_op_share$overall.att+(agg_simple_op_share$overall.se*1.95), agg_gs_op_share$att.egt+(agg_gs_op_share$se.egt*agg_gs_op_share$crit.val.egt)))
# share_results <- merge(share_results1, share_results2, by.x = "Estimate", by.y = "Estimate", all =  T)
#share_results <- share_results[c(12, 1:11),]
```


```{r include=F}
# generating a gt table
share_results_gt <- gt(share_results1, rowname_col = "Estimate") |>
              tab_header(
                title = "Aggregation of group time average treatment effects",
                subtitle = "Control group: Never treated") |>
              cols_label(
                lower="[95%",
                upper="conf.int.]"
                # ATT.x="ATT",
                # lower.x="[95%",
                # upper.x="conf.int.]",
                # ATT.y="ATT",
                # lower.y="[95%",
                # upper.y="conf.int.]"
              ) |>
              tab_spanner(label = "uncond. PTA",
                          columns = c("ATT", "lower", "upper")) |>
              # tab_spanner(label = "uncond. PTA",
              #             columns = c("ATT.x", "lower.x", "upper.x")) |>
              # tab_spanner(label = "Chinese operation",
              #             columns = c("ATT.y", "lower.y", "upper.y")) |>
              tab_row_group(label = "by group:",
                            rows = contains("(")) |>
              row_group_order(groups = c(NA,"by group:")) |>
              sub_missing(columns = everything(),
                          rows = everything(),
                          missing_text = "") |>
              tab_footnote(footnote = "Confidence interval does not include zero.",
                           location = list(
                                            cells_body(columns=c(ATT),
                                                 rows = lower > 0 | upper < 0)
                                            # cells_body(columns=c(ATT.x),
                                            #      rows = lower.x > 0 | upper.x < 0),
                                            # cells_body(columns=c(ATT.y),
                                            #      rows = lower.y > 0 | upper.y < 0)
                                           ),
                           placement = "right") |>
              tab_footnote(footnote = "First treatment period in brackets.") |>
              opt_footnote_marks(marks = "standard") |>
              fmt_number(decimals = 2)
```

```{r include=TRUE, echo=F}
share_results_gt
```


***What do I have to change in the original code to obtain estimates not for treated reporting ports but for treated country partners?***

***We do the Diff-in-Diff estimation with port-aggregate information. Is there a reason why we do not do it with bilateral (port-country) information? I would need the latter for the analysis here.***


## Estimations of China treatment effect for SEEX throughput development.

### FE estimations

### Diff-in-Diff estimations

# Testing Hypothesis 2

## Graph 

Showing the development of SEEX trade with partner countries that ship via Suez canal versus with partner countries that come in via the Atlantic.

## Estimation: FE and Diff-in-Diff

Estimate the effect on trade of all SEEX partner countries shipping via the Suez Canal after 2009. Also estimate with only China as treated after 2009.

If the estimate for all partner countries are positive and significant, we can talk about a general Suez Canal effect.

If the estimate for all partner countries are not significant but the estimate of China (+ Hong Kong, ?plus Singapore?) is, we can talk about a China effect.

# Testing Hypothesis 3

## Development of trade with the US: region comparison

```{r echo=FALSE, warning=FALSE, message=FALSE}
partner_US <- filter(port_data_TEU,      
                        partner_code=="US")

total3 <- partner_US %>% 
  group_by(reporter_region, year) %>% summarise(containerUS=sum(container, na.rm=T))

ggplot(data=total3, aes(x=year, y=containerUS, group=reporter_region))+
  geom_line(aes(color=reporter_region))+
  scale_color_manual(values = c("darkblue", "red"))+
  labs(title = "Line chart - development of trade with US")
```

Trade with the US increased for Southern European ports but had a 10-years dip for Northern European ports from 2008-2018, eventually caused by the Global Financial Crisis and the Euro crisis. 

A look in the one-directional flows shows that it is only NENE and NEEX outflows that were hit but not NENE and NEEX inflows.

***What does it mean that only NENE and NEEX outflows and not inflows were hit? I cannot make sense of what this means***

***I have still not figured out whether we can/should use bi-directional (total) flows in our analysis or if it would be correct to use one-directional flows (only inflows or outflows) instead. We have a partial double counting by using total flows but not fully double counting since our data set partners ports with countries. How severe is the double counting and what is its consequence for the descriptive statistics and the estimations? It may help to find out how much of the country flows are covered by our reporting ports. What is the aggregated fraction of container throughput from reporting ports of the same country on the country's total container throughput as reported in Eurostat?***
